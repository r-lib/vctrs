<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="vctrs">
<title>S3 vectors • vctrs</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.5/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.5/font.css" rel="stylesheet">
<!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="S3 vectors">
<meta property="og:description" content="vctrs">
<meta property="og:image" content="https://vctrs.r-lib.org/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><script defer data-domain="vctrs.r-lib.org,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-none"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">vctrs</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.6.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/pillar.html">Printing vectors nicely in tibbles</a>
    <a class="dropdown-item" href="../articles/s3-vector.html">S3 vectors</a>
    <a class="dropdown-item" href="../articles/stability.html">Type and size stability</a>
    <a class="dropdown-item" href="../articles/type-size.html">Prototypes and sizes</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/r-lib/vctrs/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>S3 vectors</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/vctrs/blob/HEAD/vignettes/s3-vector.Rmd" class="external-link"><code>vignettes/s3-vector.Rmd</code></a></small>
      <div class="d-none name"><code>s3-vector.Rmd</code></div>
    </div>

    
    
<p>This vignette shows you how to create your own S3 vector classes. It
focuses on the aspects of making a vector class that every class needs
to worry about; you’ll also need to provide methods that actually make
the vector useful.</p>
<p>I assume that you’re already familiar with the basic machinery of S3,
and the vocabulary I use in Advanced R: constructor, helper, and
validator. If not, I recommend reading at least the first two sections
of <a href="https://adv-r.hadley.nz/s3.html" class="external-link">the S3 chapter</a> of
<em>Advanced R</em>.</p>
<p>This article refers to “vectors of numbers” as <em>double
vectors</em>. Here, “double” stands for <a href="https://en.wikipedia.org/wiki/Double-precision_floating-point_format" class="external-link">“double
precision floating point number”</a>, see also
<code><a href="https://rdrr.io/r/base/double.html" class="external-link">double()</a></code>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://vctrs.r-lib.org/">vctrs</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rlang.r-lib.org" class="external-link">rlang</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/nteetor/zeallot" class="external-link">zeallot</a></span><span class="op">)</span></span></code></pre></div>
<p>This vignette works through five big topics:</p>
<ul>
<li>The basics of creating a new vector class with vctrs.</li>
<li>The coercion and casting system.</li>
<li>The record and list-of types.</li>
<li>Equality and comparison proxies.</li>
<li>Arithmetic operators.</li>
</ul>
<p>They’re collectively demonstrated with a number of simple S3
classes:</p>
<ul>
<li><p>Percent: a double vector that prints as a percentage. This
illustrates the basic mechanics of class creation, coercion, and
casting.</p></li>
<li><p>Decimal: a double vector that always prints with a fixed number
of decimal places. This class has an attribute which needs a little
extra care in casts and coercions.</p></li>
<li><p>Cached sum: a double vector that caches the total sum in an
attribute. The attribute depends on the data, so needs extra
care.</p></li>
<li><p>Rational: a pair of integer vectors that defines a rational
number like <code>2 / 3</code>. This introduces you to the record style,
and to the equality and comparison operators. It also needs special
handling for <code>+</code>, <code>-</code>, and friends.</p></li>
<li><p>Polynomial: a list of integer vectors that define polynomials
like <code>1 + x - x^3</code>. Sorting such vectors correctly requires a
custom equality method.</p></li>
<li><p>Meter: a numeric vector with meter units. This is the simplest
possible class with interesting algebraic properties.</p></li>
<li><p>Period and frequency: a pair of classes represent a period, or
it’s inverse, frequency. This allows us to explore more arithmetic
operators.</p></li>
</ul>
<div class="section level2">
<h2 id="basics">Basics<a class="anchor" aria-label="anchor" href="#basics"></a>
</h2>
<p>In this section you’ll learn how to create a new vctrs class by
calling <code><a href="../reference/new_vctr.html">new_vctr()</a></code>. This creates an object with class
<code>vctrs_vctr</code> which has a number of methods. These are
designed to make your life as easy as possible. For example:</p>
<ul>
<li><p>The <code><a href="https://rdrr.io/r/base/print.html" class="external-link">print()</a></code> and <code><a href="https://rdrr.io/r/utils/str.html" class="external-link">str()</a></code> methods are
defined in terms of <code><a href="https://rdrr.io/r/base/format.html" class="external-link">format()</a></code> so you get a pleasant,
consistent display as soon as you’ve made your <code><a href="https://rdrr.io/r/base/format.html" class="external-link">format()</a></code>
method.</p></li>
<li><p>You can immediately put your new vector class in a data frame
because <code>as.data.frame.vctrs_vctr()</code> does the right
thing.</p></li>
<li><p>Subsetting (<code>[</code>, <code>[[</code>, and <code>$</code>),
<code>length&lt;-</code>, and <code><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep()</a></code> methods automatically
preserve attributes because they use <code><a href="../reference/vec_proxy.html">vec_restore()</a></code>. A
default <code><a href="../reference/vec_proxy.html">vec_restore()</a></code> works for all classes where the
attributes are data-independent, and can easily be customised when the
attributes do depend on the data.</p></li>
<li><p>Default subset-assignment methods (<code>[&lt;-</code>,
<code>[[&lt;-</code>, and <code>$&lt;-</code>) follow the principle that
the new values should be coerced to match the existing vector. This
gives predictable behaviour and clear error messages.</p></li>
</ul>
<div class="section level3">
<h3 id="percent-class">Percent class<a class="anchor" aria-label="anchor" href="#percent-class"></a>
</h3>
<p>In this section, I’ll show you how to make a <code>percent</code>
class, i.e., a double vector that is printed as a percentage. We start
by defining a low-level <a href="https://adv-r.hadley.nz/s3.html#s3-constrcutor" class="external-link">constructor</a> to
check types and/or sizes and call <code><a href="../reference/new_vctr.html">new_vctr()</a></code>.</p>
<p><code>percent</code> is built on a double vector of any length and
doesn’t have any attributes.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">new_percent</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">double</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rlang.r-lib.org/reference/type-predicates.html" class="external-link">is_double</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rlang.r-lib.org/reference/abort.html" class="external-link">abort</a></span><span class="op">(</span><span class="st">"`x` must be a double vector."</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="fu"><a href="../reference/new_vctr.html">new_vctr</a></span><span class="op">(</span><span class="va">x</span>, class <span class="op">=</span> <span class="st">"vctrs_percent"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">new_percent</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, length.out <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">x</span></span>
<span><span class="co">#&gt; &lt;vctrs_percent[5]&gt;</span></span>
<span><span class="co">#&gt; [1] 0.0000000 0.3333333 0.6666667 1.0000000        NA</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt;  vctrs_pr [1:5] 0.0000000, 0.3333333, 0.6666667, 1.0000000,        NA</span></span></code></pre></div>
<p>Note that we prefix the name of the class with the name of the
package. This prevents conflicting definitions between packages. For
packages that implement only one class (such as <a href="https://blob.tidyverse.org/" class="external-link">blob</a>), it’s fine to use the
package name without prefix as the class name.</p>
<p>We then follow up with a user friendly <a href="https://adv-r.hadley.nz/s3.html#helpers" class="external-link">helper</a>. Here we’ll
use <code><a href="../reference/vec_cast.html">vec_cast()</a></code> to allow it to accept anything coercible to
a double:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">percent</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">double</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/vec_cast.html">vec_cast</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">double</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu">new_percent</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Before you go on, check that user-friendly constructor returns a
zero-length vector when called with no arguments. This makes it easy to
use as a prototype.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">new_percent</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;vctrs_percent[0]&gt;</span></span>
<span><span class="fu">percent</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;vctrs_percent[0]&gt;</span></span></code></pre></div>
<p>For the convenience of your users, consider implementing an
<code>is_percent()</code> function:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">is_percent</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"vctrs_percent"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="format-method">
<code>format()</code> method<a class="anchor" aria-label="anchor" href="#format-method"></a>
</h3>
<p>The first method for every class should almost always be a
<code><a href="https://rdrr.io/r/base/format.html" class="external-link">format()</a></code> method. This should return a character vector the
same length as <code>x</code>. The easiest way to do this is to rely on
one of R’s low-level formatting functions like
<code><a href="https://rdrr.io/r/base/formatc.html" class="external-link">formatC()</a></code>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">format.vctrs_percent</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/formatc.html" class="external-link">formatC</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">signif</a></span><span class="op">(</span><span class="fu"><a href="../reference/vec_data.html">vec_data</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">out</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span>  <span class="va">out</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">out</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">]</span>, <span class="st">"%"</span><span class="op">)</span></span>
<span>  <span class="va">out</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span></span>
<span><span class="co">#&gt; &lt;vctrs_percent[5]&gt;</span></span>
<span><span class="co">#&gt; [1] 0%    33.3% 66.7% 100%  &lt;NA&gt;</span></span></code></pre></div>
<p>(Note the use of <code><a href="../reference/vec_data.html">vec_data()</a></code> so <code><a href="https://rdrr.io/r/base/format.html" class="external-link">format()</a></code>
doesn’t get stuck in an infinite loop, and that I take a little care to
not convert <code>NA</code> to <code>"NA"</code>; this leads to better
printing.)</p>
<p>The format method is also used by data frames, tibbles, and
<code><a href="https://rdrr.io/r/utils/str.html" class="external-link">str()</a></code>:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt;       x</span></span>
<span><span class="co">#&gt; 1    0%</span></span>
<span><span class="co">#&gt; 2 33.3%</span></span>
<span><span class="co">#&gt; 3 66.7%</span></span>
<span><span class="co">#&gt; 4  100%</span></span>
<span><span class="co">#&gt; 5  &lt;NA&gt;</span></span></code></pre></div>
<p>For optimal display, I recommend also defining an abbreviated type
name, which should be 4-5 letters for commonly used vectors. This is
used in tibbles and in <code><a href="https://rdrr.io/r/utils/str.html" class="external-link">str()</a></code>:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vec_ptype_abbr.vctrs_percent</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="st">"prcnt"</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 5 × 1</span></span></span>
<span><span class="co">#&gt;         x</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;prcnt&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>      0%</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>   33.3%</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>   66.7%</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>    100%</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>      <span style="color: #BB0000;">NA</span></span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt;  prcnt [1:5] 0%, 33.3%, 66.7%, 100%, &lt;NA&gt;</span></span></code></pre></div>
<p>If you need more control over printing in tibbles, implement a method
for <code><a href="https://pillar.r-lib.org/reference/pillar_shaft.html" class="external-link">pillar::pillar_shaft()</a></code>. See
<code><a href="../articles/pillar.html">vignette("pillar", package = "vctrs")</a></code> for details.</p>
</div>
</div>
<div class="section level2">
<h2 id="casting-and-coercion">Casting and coercion<a class="anchor" aria-label="anchor" href="#casting-and-coercion"></a>
</h2>
<p>The next set of methods you are likely to need are those related to
coercion and casting. Coercion and casting are two sides of the same
coin: changing the prototype of an existing object. When the change
happens <em>implicitly</em> (e.g in <code><a href="https://rdrr.io/r/base/c.html" class="external-link">c()</a></code>) we call it
<strong>coercion</strong>; when the change happens <em>explicitly</em>
(e.g. with <code>as.integer(x)</code>), we call it
<strong>casting</strong>.</p>
<p>One of the main goals of vctrs is to put coercion and casting on a
robust theoretical footing so it’s possible to make accurate predictions
about what (e.g.) <code>c(x, y)</code> should do when <code>x</code> and
<code>y</code> have different prototypes. vctrs achieves this goal
through two generics:</p>
<ul>
<li><p><code>vec_ptype2(x, y)</code> defines possible set of coercions.
It returns a prototype if <code>x</code> and <code>y</code> can be
safely coerced to the same prototype; otherwise it returns an error. The
set of automatic coercions is usually quite small because too many tend
to make code harder to reason about and silently propagate
mistakes.</p></li>
<li><p><code>vec_cast(x, to)</code> defines the possible sets of casts.
It returns <code>x</code> translated to have prototype <code>to</code>,
or throws an error if the conversion isn’t possible. The set of possible
casts is a superset of possible coercions because they’re requested
explicitly.</p></li>
</ul>
<div class="section level3">
<h3 id="double-dispatch">Double dispatch<a class="anchor" aria-label="anchor" href="#double-dispatch"></a>
</h3>
<p>Both generics use <a href="https://en.wikipedia.org/wiki/Double_dispatch" class="external-link"><strong>double
dispatch</strong></a> which means that the implementation is selected
based on the class of two arguments, not just one. S3 does not natively
support double dispatch, so we implement our own dispatch mechanism. In
practice, this means:</p>
<ul>
<li><p>You end up with method names with two classes, like
<code>vec_ptype2.foo.bar()</code>.</p></li>
<li><p>You don’t need to implement default methods (they would never be
called if you do).</p></li>
<li><p>You can’t call <code><a href="https://rdrr.io/r/base/UseMethod.html" class="external-link">NextMethod()</a></code>.</p></li>
</ul>
</div>
<div class="section level3">
<h3 id="percent">Percent class<a class="anchor" aria-label="anchor" href="#percent"></a>
</h3>
<p>We’ll make our percent class coercible back and forth with double
vectors.</p>
<p><code><a href="../reference/vec_ptype2.html">vec_ptype2()</a></code> provides a user friendly error message if
the coercion doesn’t exist and makes sure <code>NA</code> is handled in
a standard way. <code>NA</code> is technically a logical vector, but we
want to stand in for a missing value of any type.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/vec_ptype2.html">vec_ptype2</a></span><span class="op">(</span><span class="st">"bogus"</span>, <span class="fu">percent</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;">:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> Can't combine `"bogus"` &lt;character&gt; and `percent()` &lt;vctrs_percent&gt;.</span></span>
<span><span class="fu"><a href="../reference/vec_ptype2.html">vec_ptype2</a></span><span class="op">(</span><span class="fu">percent</span><span class="op">(</span><span class="op">)</span>, <span class="cn">NA</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;vctrs_percent[0]&gt;</span></span>
<span><span class="fu"><a href="../reference/vec_ptype2.html">vec_ptype2</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu">percent</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;vctrs_percent[0]&gt;</span></span></code></pre></div>
<p>By default and in simple cases, an object of the same class is
compatible with itself:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/vec_ptype2.html">vec_ptype2</a></span><span class="op">(</span><span class="fu">percent</span><span class="op">(</span><span class="op">)</span>, <span class="fu">percent</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;vctrs_percent[0]&gt;</span></span></code></pre></div>
<p>However this only works if the attributes for both objects are the
same. Also the default methods are a bit slower. It is always a good
idea to provide an explicit coercion method for the case of identical
classes. So we’ll start by saying that a <code>vctrs_percent</code>
combined with a <code>vctrs_percent</code> yields a
<code>vctrs_percent</code>, which we indicate by returning a prototype
generated by the constructor.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vec_ptype2.vctrs_percent.vctrs_percent</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">...</span><span class="op">)</span> <span class="fu">new_percent</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Next we define methods that say that combining a <code>percent</code>
and double should yield a <code>double</code>. We avoid returning a
<code>percent</code> here because errors in the scale (1 vs. 0.01) are
more obvious with raw numbers.</p>
<p>Because double dispatch is a bit of a hack, we need to provide two
methods. It’s your responsibility to ensure that each member of the pair
returns the same result: if they don’t you will get weird and
unpredictable behaviour.</p>
<p>The double dispatch mechanism requires us to refer to the underlying
type, <code>double</code>, in the method name. If we implemented
<code>vec_ptype2.vctrs_percent.numeric()</code>, it would never be
called.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vec_ptype2.vctrs_percent.double</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">...</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">double</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">vec_ptype2.double.vctrs_percent</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">...</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">double</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>We can check that we’ve implemented this correctly with
<code><a href="../reference/vec_ptype.html">vec_ptype_show()</a></code>:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/vec_ptype.html">vec_ptype_show</a></span><span class="op">(</span><span class="fu">percent</span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">double</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu">percent</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Prototype: &lt;double&gt;</span></span>
<span><span class="co">#&gt; 0. (                 , &lt;vctrs_percent&gt; ) = &lt;vctrs_percent&gt;</span></span>
<span><span class="co">#&gt; 1. ( &lt;vctrs_percent&gt; , &lt;double&gt;        ) = &lt;double&gt;       </span></span>
<span><span class="co">#&gt; 2. ( &lt;double&gt;        , &lt;vctrs_percent&gt; ) = &lt;double&gt;</span></span></code></pre></div>
<p>The <code><a href="../reference/vec_ptype2.html">vec_ptype2()</a></code> methods define which input is the
richer type that vctrs should coerce to. However, they don’t perform any
conversion. This is the job of <code><a href="../reference/vec_cast.html">vec_cast()</a></code>, which we
implement next. We’ll provide a method to cast a percent to a
percent:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vec_cast.vctrs_percent.vctrs_percent</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">to</span>, <span class="va">...</span><span class="op">)</span> <span class="va">x</span></span></code></pre></div>
<p>And then for converting back and forth between doubles. To convert a
double to a percent we use the <code>percent()</code> helper (not the
constructor; this is unvalidated user input). To convert a
<code>percent</code> to a double, we strip the attributes.</p>
<p>Note that for historical reasons the order of argument in the
signature is the opposite as for <code><a href="../reference/vec_ptype2.html">vec_ptype2()</a></code>. The class
for <code>to</code> comes first, and the class for <code>x</code> comes
second.</p>
<p>Again, the double dispatch mechanism requires us to refer to the
underlying type, <code>double</code>, in the method name. Implementing
<code>vec_cast.vctrs_percent.numeric()</code> has no effect.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vec_cast.vctrs_percent.double</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">to</span>, <span class="va">...</span><span class="op">)</span> <span class="fu">percent</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="va">vec_cast.double.vctrs_percent</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">to</span>, <span class="va">...</span><span class="op">)</span> <span class="fu"><a href="../reference/vec_data.html">vec_data</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span></code></pre></div>
<p>Then we can check this works with <code><a href="../reference/vec_cast.html">vec_cast()</a></code>:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/vec_cast.html">vec_cast</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fu">percent</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;vctrs_percent[1]&gt;</span></span>
<span><span class="co">#&gt; [1] 50%</span></span>
<span><span class="fu"><a href="../reference/vec_cast.html">vec_cast</a></span><span class="op">(</span><span class="fu">percent</span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">double</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.5</span></span></code></pre></div>
<p>Once you’ve implemented <code><a href="../reference/vec_ptype2.html">vec_ptype2()</a></code> and
<code><a href="../reference/vec_cast.html">vec_cast()</a></code>, you get <code><a href="../reference/vec_c.html">vec_c()</a></code>,
<code>[&lt;-</code>, and <code>[[&lt;-</code> implementations for
free.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/vec_c.html">vec_c</a></span><span class="op">(</span><span class="fu">percent</span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.5 1.0</span></span>
<span><span class="fu"><a href="../reference/vec_c.html">vec_c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu">percent</span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;vctrs_percent[2]&gt;</span></span>
<span><span class="co">#&gt; [1] &lt;NA&gt; 50%</span></span>
<span><span class="co"># but</span></span>
<span><span class="fu"><a href="../reference/vec_c.html">vec_c</a></span><span class="op">(</span><span class="cn">TRUE</span>, <span class="fu">percent</span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `vec_c()`:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> Can't combine `..1` &lt;logical&gt; and `..2` &lt;vctrs_percent&gt;.</span></span>
<span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">percent</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">2</span><span class="op">:</span><span class="fl">1</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `vec_restore_dispatch()`:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> Can't convert &lt;integer&gt; to &lt;vctrs_percent&gt;.</span></span>
<span><span class="va">x</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.5</span></span>
<span><span class="va">x</span></span>
<span><span class="co">#&gt; &lt;vctrs_percent[3]&gt;</span></span>
<span><span class="co">#&gt; [1] 50%  100% 50%</span></span></code></pre></div>
<p>You’ll also get mostly correct behaviour for <code><a href="https://rdrr.io/r/base/c.html" class="external-link">c()</a></code>. The
exception is when you use <code><a href="https://rdrr.io/r/base/c.html" class="external-link">c()</a></code> with a base R class:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Correct</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu">percent</span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.5 1.0</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu">percent</span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `vec_c()`:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> Can't combine `..1` &lt;vctrs_percent&gt; and `..2` &lt;factor&lt;25c7e&gt;&gt;.</span></span>
<span></span>
<span><span class="co"># Incorrect</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, <span class="fu">percent</span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1.0 0.5</span></span></code></pre></div>
<p>Unfortunately there’s no way to fix this problem with the current
design of <code><a href="https://rdrr.io/r/base/c.html" class="external-link">c()</a></code>.</p>
<p>Again, as a convenience, consider providing an
<code>as_percent()</code> function that makes use of the casts defined
in your <code>vec_cast.vctrs_percent()</code> methods:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">as_percent</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/vec_cast.html">vec_cast</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu">new_percent</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Occasionally, it is useful to provide conversions that go beyond
what’s allowed in casting. For example, we could offer a parsing method
for character vectors. In this case, <code>as_percent()</code> should be
generic, the default method should cast, and then additional methods
should implement more flexible conversion:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">as_percent</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/UseMethod.html" class="external-link">UseMethod</a></span><span class="op">(</span><span class="st">"as_percent"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">as_percent.default</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/vec_cast.html">vec_cast</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu">new_percent</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">as_percent.character</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">value</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">" *% *$"</span>, <span class="st">""</span>, <span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fl">100</span></span>
<span>  <span class="fu">new_percent</span><span class="op">(</span><span class="va">value</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="decimal-class">Decimal class<a class="anchor" aria-label="anchor" href="#decimal-class"></a>
</h3>
<p>Now that you’ve seen the basics with a very simple S3 class, we’ll
gradually explore more complicated scenarios. This section creates a
<code>decimal</code> class that prints with the specified number of
decimal places. This is very similar to <code>percent</code> but now the
class needs an attribute: the number of decimal places to display (an
integer vector of length 1).</p>
<p>We start off as before, defining a low-level constructor, a
user-friendly constructor, a <code><a href="https://rdrr.io/r/base/format.html" class="external-link">format()</a></code> method, and a
<code><a href="../reference/vec_ptype_full.html">vec_ptype_abbr()</a></code>. Note that additional object attributes
are simply passed along to <code><a href="../reference/new_vctr.html">new_vctr()</a></code>:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">new_decimal</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">double</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">digits</span> <span class="op">=</span> <span class="fl">2L</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rlang.r-lib.org/reference/type-predicates.html" class="external-link">is_double</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rlang.r-lib.org/reference/abort.html" class="external-link">abort</a></span><span class="op">(</span><span class="st">"`x` must be a double vector."</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rlang.r-lib.org/reference/type-predicates.html" class="external-link">is_integer</a></span><span class="op">(</span><span class="va">digits</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rlang.r-lib.org/reference/abort.html" class="external-link">abort</a></span><span class="op">(</span><span class="st">"`digits` must be an integer vector."</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="fu"><a href="../reference/vector-checks.html">vec_check_size</a></span><span class="op">(</span><span class="va">digits</span>, size <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="../reference/new_vctr.html">new_vctr</a></span><span class="op">(</span><span class="va">x</span>, digits <span class="op">=</span> <span class="va">digits</span>, class <span class="op">=</span> <span class="st">"vctrs_decimal"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">decimal</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">double</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">digits</span> <span class="op">=</span> <span class="fl">2L</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/vec_cast.html">vec_cast</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">double</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">digits</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/vec_recycle.html">vec_recycle</a></span><span class="op">(</span><span class="fu"><a href="../reference/vec_cast.html">vec_cast</a></span><span class="op">(</span><span class="va">digits</span>, <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>, <span class="fl">1L</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu">new_decimal</span><span class="op">(</span><span class="va">x</span>, digits <span class="op">=</span> <span class="va">digits</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">digits</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"digits"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">format.vctrs_decimal</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"%-0."</span>, <span class="fu">digits</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="st">"f"</span><span class="op">)</span>, <span class="va">x</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">vec_ptype_abbr.vctrs_decimal</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="st">"dec"</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">decimal</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>, <span class="fl">1L</span><span class="op">)</span></span>
<span><span class="va">x</span></span>
<span><span class="co">#&gt; &lt;vctrs_decimal[10]&gt;</span></span>
<span><span class="co">#&gt;  [1] 0.1 0.8 0.6 0.2 0.0 0.5 0.5 0.3 0.7 0.8</span></span></code></pre></div>
<p>Note that I provide a little helper to extract the
<code>digits</code> attribute. This makes the code a little easier to
read and should not be exported.</p>
<p>By default, vctrs assumes that attributes are independent of the data
and so are automatically preserved. You’ll see what to do if the
attributes are data dependent in the next section.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span></span>
<span><span class="co">#&gt; &lt;vctrs_decimal[2]&gt;</span></span>
<span><span class="co">#&gt; [1] 0.1 0.8</span></span>
<span><span class="va">x</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; &lt;vctrs_decimal[1]&gt;</span></span>
<span><span class="co">#&gt; [1] 0.1</span></span></code></pre></div>
<p>For the sake of exposition, we’ll assume that <code>digits</code> is
an important attribute of the class and should be included in the full
type:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vec_ptype_full.vctrs_decimal</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"decimal&lt;"</span>, <span class="fu">digits</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="st">"&gt;"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">x</span></span>
<span><span class="co">#&gt; &lt;decimal&lt;1&gt;[10]&gt;</span></span>
<span><span class="co">#&gt;  [1] 0.1 0.8 0.6 0.2 0.0 0.5 0.5 0.3 0.7 0.8</span></span></code></pre></div>
<p>Now consider <code><a href="../reference/vec_cast.html">vec_cast()</a></code> and <code><a href="../reference/vec_ptype2.html">vec_ptype2()</a></code>.
Casting and coercing from one decimal to another requires a little
thought as the values of the <code>digits</code> attribute might be
different, and we need some way to reconcile them. Here I’ve decided to
chose the maximum of the two; other reasonable options are to take the
value from the left-hand side or throw an error.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vec_ptype2.vctrs_decimal.vctrs_decimal</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">new_decimal</span><span class="op">(</span>digits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu">digits</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="fu">digits</span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">vec_cast.vctrs_decimal.vctrs_decimal</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">to</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">new_decimal</span><span class="op">(</span><span class="fu"><a href="../reference/vec_data.html">vec_data</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, digits <span class="op">=</span> <span class="fu">digits</span><span class="op">(</span><span class="va">to</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="../reference/vec_c.html">vec_c</a></span><span class="op">(</span><span class="fu">decimal</span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="fl">100</span>, digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>, <span class="fu">decimal</span><span class="op">(</span><span class="fl">2</span><span class="op">/</span><span class="fl">100</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;decimal&lt;3&gt;[2]&gt;</span></span>
<span><span class="co">#&gt; [1] 0.010 0.020</span></span></code></pre></div>
<p>Finally, I can implement coercion to and from other types, like
doubles. When automatically coercing, I choose the richer type (i.e.,
the decimal).</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vec_ptype2.vctrs_decimal.double</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">...</span><span class="op">)</span> <span class="va">x</span></span>
<span><span class="va">vec_ptype2.double.vctrs_decimal</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">...</span><span class="op">)</span> <span class="va">y</span></span>
<span></span>
<span><span class="va">vec_cast.vctrs_decimal.double</span>  <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">to</span>, <span class="va">...</span><span class="op">)</span> <span class="fu">new_decimal</span><span class="op">(</span><span class="va">x</span>, digits <span class="op">=</span> <span class="fu">digits</span><span class="op">(</span><span class="va">to</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">vec_cast.double.vctrs_decimal</span>  <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">to</span>, <span class="va">...</span><span class="op">)</span> <span class="fu"><a href="../reference/vec_data.html">vec_data</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/vec_c.html">vec_c</a></span><span class="op">(</span><span class="fu">decimal</span><span class="op">(</span><span class="fl">1</span>, digits <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, <span class="va">pi</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;decimal&lt;1&gt;[2]&gt;</span></span>
<span><span class="co">#&gt; [1] 1.0 3.1</span></span>
<span><span class="fu"><a href="../reference/vec_c.html">vec_c</a></span><span class="op">(</span><span class="va">pi</span>, <span class="fu">decimal</span><span class="op">(</span><span class="fl">1</span>, digits <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;decimal&lt;1&gt;[2]&gt;</span></span>
<span><span class="co">#&gt; [1] 3.1 1.0</span></span></code></pre></div>
<p>If type <code>x</code> has greater resolution than <code>y</code>,
there will be some inputs that lose precision. These should generate
errors using <code>stop_lossy_cast()</code>. You can see that in action
when casting from doubles to integers; only some doubles can become
integers without losing resolution.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/vec_cast.html">vec_cast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">10</span><span class="op">)</span>, to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]  1  2 10</span></span>
<span></span>
<span><span class="fu"><a href="../reference/vec_cast.html">vec_cast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.5</span>, <span class="fl">2</span>, <span class="fl">10.5</span><span class="op">)</span>, to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;">:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> Can't convert from `c(1.5, 2, 10.5)` &lt;double&gt; to &lt;integer&gt; due to loss of precision.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> Locations: 1, 3</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="cached-sum">Cached sum class<a class="anchor" aria-label="anchor" href="#cached-sum"></a>
</h3>
<p>The next level up in complexity is an object that has data-dependent
attributes. To explore this idea we’ll create a vector that caches the
sum of its values. As usual, we start with low-level and user-friendly
constructors:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">new_cached_sum</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">double</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">sum</span> <span class="op">=</span> <span class="fl">0L</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rlang.r-lib.org/reference/type-predicates.html" class="external-link">is_double</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rlang.r-lib.org/reference/abort.html" class="external-link">abort</a></span><span class="op">(</span><span class="st">"`x` must be a double vector."</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rlang.r-lib.org/reference/type-predicates.html" class="external-link">is_double</a></span><span class="op">(</span><span class="va">sum</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rlang.r-lib.org/reference/abort.html" class="external-link">abort</a></span><span class="op">(</span><span class="st">"`sum` must be a double vector."</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="fu"><a href="../reference/vector-checks.html">vec_check_size</a></span><span class="op">(</span><span class="va">sum</span>, size <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="../reference/new_vctr.html">new_vctr</a></span><span class="op">(</span><span class="va">x</span>, sum <span class="op">=</span> <span class="va">sum</span>, class <span class="op">=</span> <span class="st">"vctrs_cached_sum"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">cached_sum</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/vec_cast.html">vec_cast</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">double</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu">new_cached_sum</span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>For this class, we can use the default <code><a href="https://rdrr.io/r/base/format.html" class="external-link">format()</a></code> method,
and instead, we’ll customise the <code><a href="../reference/obj_print.html">obj_print_footer()</a></code> method.
This is a good place to display user facing attributes.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">obj_print_footer.vctrs_cached_sum</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"# Sum: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"sum"</span><span class="op">)</span>, digits <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>, <span class="st">"\n"</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">cached_sum</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">x</span></span>
<span><span class="co">#&gt; &lt;vctrs_cached_sum[10]&gt;</span></span>
<span><span class="co">#&gt;  [1] 0.87460066 0.17494063 0.03424133 0.32038573 0.40232824 0.19566983</span></span>
<span><span class="co">#&gt;  [7] 0.40353812 0.06366146 0.38870131 0.97554784</span></span>
<span><span class="co">#&gt; # Sum: 3.83</span></span></code></pre></div>
<p>We’ll also override <code><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum()</a></code> and <code><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean()</a></code> to use
the attribute. This is easiest to do with <code><a href="../reference/vec_math.html">vec_math()</a></code>, which
you’ll learn about later.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vec_math.vctrs_cached_sum</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">.fn</span>, <span class="va">.x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Using cache\n"</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/switch.html" class="external-link">switch</a></span><span class="op">(</span><span class="va">.fn</span>,</span>
<span>    sum <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">.x</span>, <span class="st">"sum"</span><span class="op">)</span>,</span>
<span>    mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">.x</span>, <span class="st">"sum"</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/vec_math.html">vec_math_base</a></span><span class="op">(</span><span class="va">.fn</span>, <span class="va">.x</span>, <span class="va">...</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; Using cache</span></span>
<span><span class="co">#&gt; [1] 3.833615</span></span></code></pre></div>
<p>As mentioned above, vctrs assumes that attributes are independent of
the data. This means that when we take advantage of the default methods,
they’ll work, but return the incorrect result:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span></span>
<span><span class="co">#&gt; &lt;vctrs_cached_sum[2]&gt;</span></span>
<span><span class="co">#&gt; [1] 0.8746007 0.1749406</span></span>
<span><span class="co">#&gt; # Sum: 3.83</span></span></code></pre></div>
<p>To fix this, you need to provide a <code><a href="../reference/vec_proxy.html">vec_restore()</a></code> method.
Note that this method dispatches on the <code>to</code> argument.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vec_restore.vctrs_cached_sum</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">to</span>, <span class="va">...</span>, <span class="va">i</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">new_cached_sum</span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="co">#&gt; &lt;vctrs_cached_sum[1]&gt;</span></span>
<span><span class="co">#&gt; [1] 0.8746007</span></span>
<span><span class="co">#&gt; # Sum: 0.875</span></span></code></pre></div>
<p>This works because most of the vctrs methods dispatch to the
underlying base function by first stripping off extra attributes with
<code><a href="../reference/vec_data.html">vec_data()</a></code> and then reapplying them again with
<code><a href="../reference/vec_proxy.html">vec_restore()</a></code>. The default <code><a href="../reference/vec_proxy.html">vec_restore()</a></code>
method copies over all attributes, which is not appropriate when the
attributes depend on the data.</p>
<p>Note that <code>vec_restore.class</code> is subtly different from
<code>vec_cast.class.class()</code>. <code><a href="../reference/vec_proxy.html">vec_restore()</a></code> is used
when restoring attributes that have been lost; <code><a href="../reference/vec_cast.html">vec_cast()</a></code>
is used for coercions. This is easier to understand with a concrete
example. Imagine factors were implemented with <code><a href="../reference/new_vctr.html">new_vctr()</a></code>.
<code>vec_restore.factor()</code> would restore attributes back to an
integer vector, but you would not want to allow manually casting an
integer to a factor with <code><a href="../reference/vec_cast.html">vec_cast()</a></code>.</p>
</div>
</div>
<div class="section level2">
<h2 id="record-style-objects">Record-style objects<a class="anchor" aria-label="anchor" href="#record-style-objects"></a>
</h2>
<p>Record-style objects use a list of equal-length vectors to represent
individual components of the object. The best example of this is
<code>POSIXlt</code>, which underneath the hood is a list of 11 fields
like year, month, and day. Record-style classes override
<code><a href="https://rdrr.io/r/base/length.html" class="external-link">length()</a></code> and subsetting methods to conceal this
implementation detail.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html" class="external-link">as.POSIXlt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ISOdatetime.html" class="external-link">ISOdatetime</a></span><span class="op">(</span><span class="fl">2020</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">x</span></span>
<span><span class="co">#&gt; [1] "2020-01-01 00:00:01 UTC" "2020-01-01 00:00:02 UTC"</span></span>
<span><span class="co">#&gt; [3] "2020-01-01 00:00:03 UTC"</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 3</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">unclass</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 9</span></span>
<span></span>
<span><span class="va">x</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="co"># the first date time</span></span>
<span><span class="co">#&gt; [1] "2020-01-01 00:00:01 UTC"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">unclass</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="co"># the first component, the number of seconds</span></span>
<span><span class="co">#&gt; [1] 1 2 3</span></span></code></pre></div>
<p>vctrs makes it easy to create new record-style classes using
<code><a href="../reference/new_rcrd.html">new_rcrd()</a></code>, which has a wide selection of default
methods.</p>
<div class="section level3">
<h3 id="rational-class">Rational class<a class="anchor" aria-label="anchor" href="#rational-class"></a>
</h3>
<p>A fraction, or rational number, can be represented by a pair of
integer vectors representing the numerator (the number on top) and the
denominator (the number on bottom), where the length of each vector must
be the same. To represent such a data structure we turn to a new base
data type: the record (or rcrd for short).</p>
<p>As usual we start with low-level and user-friendly constructors. The
low-level constructor calls <code><a href="../reference/new_rcrd.html">new_rcrd()</a></code>, which needs a named
list of equal-length vectors.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">new_rational</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">d</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rlang.r-lib.org/reference/type-predicates.html" class="external-link">is_integer</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rlang.r-lib.org/reference/abort.html" class="external-link">abort</a></span><span class="op">(</span><span class="st">"`n` must be an integer vector."</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rlang.r-lib.org/reference/type-predicates.html" class="external-link">is_integer</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rlang.r-lib.org/reference/abort.html" class="external-link">abort</a></span><span class="op">(</span><span class="st">"`d` must be an integer vector."</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="fu"><a href="../reference/new_rcrd.html">new_rcrd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">n</span>, d <span class="op">=</span> <span class="va">d</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"vctrs_rational"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Our user friendly constructor casts <code>n</code> and <code>d</code>
to integers and recycles them to the same length.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rational</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">d</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">d</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/zeallot/man/operator.html" class="external-link">%&lt;-%</a></span> <span class="fu"><a href="../reference/vec_cast.html">vec_cast_common</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">d</span>, .to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">d</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/zeallot/man/operator.html" class="external-link">%&lt;-%</a></span> <span class="fu"><a href="../reference/vec_recycle.html">vec_recycle_common</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">d</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu">new_rational</span><span class="op">(</span><span class="va">n</span>, <span class="va">d</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">rational</span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<p>Behind the scenes, <code>x</code> is a named list with two elements.
But those details are hidden so that it behaves like a vector:</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 10</span></span></code></pre></div>
<p>To access the underlying fields we need to use <code><a href="../reference/fields.html">field()</a></code>
and <code><a href="../reference/fields.html">fields()</a></code>:</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/fields.html">fields</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "n" "d"</span></span>
<span><span class="fu"><a href="../reference/fields.html">field</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"n"</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] 1 1 1 1 1 1 1 1 1 1</span></span></code></pre></div>
<p>Notice that we can’t <code><a href="https://rdrr.io/r/base/print.html" class="external-link">print()</a></code> or <code><a href="https://rdrr.io/r/utils/str.html" class="external-link">str()</a></code> the
new rational vector <code>x</code> yet. Printing causes an error:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span></span>
<span><span class="co">#&gt; &lt;vctrs_rational[10]&gt;</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `format()`:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> `format.vctrs_rational()` not implemented.</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `format()`:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> `format.vctrs_rational()` not implemented.</span></span></code></pre></div>
<p>This is because we haven’t defined how our class can be printed from
the underlying data. Note that if you want to look under the hood during
development, you can always call <code>vec_data(x)</code>.</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/vec_data.html">vec_data</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt;    n  d</span></span>
<span><span class="co">#&gt; 1  1  1</span></span>
<span><span class="co">#&gt; 2  1  2</span></span>
<span><span class="co">#&gt; 3  1  3</span></span>
<span><span class="co">#&gt; 4  1  4</span></span>
<span><span class="co">#&gt; 5  1  5</span></span>
<span><span class="co">#&gt; 6  1  6</span></span>
<span><span class="co">#&gt; 7  1  7</span></span>
<span><span class="co">#&gt; 8  1  8</span></span>
<span><span class="co">#&gt; 9  1  9</span></span>
<span><span class="co">#&gt; 10 1 10</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="fu"><a href="../reference/vec_data.html">vec_data</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; 'data.frame':    10 obs. of  2 variables:</span></span>
<span><span class="co">#&gt;  $ n: int  1 1 1 1 1 1 1 1 1 1</span></span>
<span><span class="co">#&gt;  $ d: int  1 2 3 4 5 6 7 8 9 10</span></span></code></pre></div>
<p>It is generally best to define a formatting method early in the
development of a class. The format method defines how to display the
class so that it can be printed in the normal way:</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">format.vctrs_rational</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fields.html">field</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"n"</span><span class="op">)</span></span>
<span>  <span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fields.html">field</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"d"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">n</span>, <span class="st">"/"</span>, <span class="va">d</span><span class="op">)</span></span>
<span>  <span class="va">out</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span></span>
<span>  <span class="va">out</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">vec_ptype_abbr.vctrs_rational</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="st">"rtnl"</span></span>
<span><span class="va">vec_ptype_full.vctrs_rational</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="st">"rational"</span></span>
<span></span>
<span><span class="va">x</span></span>
<span><span class="co">#&gt; &lt;rational[10]&gt;</span></span>
<span><span class="co">#&gt;  [1] 1/1  1/2  1/3  1/4  1/5  1/6  1/7  1/8  1/9  1/10</span></span></code></pre></div>
<p>vctrs uses the <code><a href="https://rdrr.io/r/base/format.html" class="external-link">format()</a></code> method in <code><a href="https://rdrr.io/r/utils/str.html" class="external-link">str()</a></code>,
hiding the underlying implementation details from the user:</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt;  rtnl [1:10] 1/1, 1/2, 1/3, 1/4, 1/5, 1/6, 1/7, 1/8, 1/9, 1/10</span></span></code></pre></div>
<p>For <code>rational</code>, <code><a href="../reference/vec_ptype2.html">vec_ptype2()</a></code> and
<code><a href="../reference/vec_cast.html">vec_cast()</a></code> follow the same pattern as
<code>percent()</code>. We allow coercion from integer and to
doubles.</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vec_ptype2.vctrs_rational.vctrs_rational</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">...</span><span class="op">)</span> <span class="fu">new_rational</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">vec_ptype2.vctrs_rational.integer</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">...</span><span class="op">)</span> <span class="fu">new_rational</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">vec_ptype2.integer.vctrs_rational</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">...</span><span class="op">)</span> <span class="fu">new_rational</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">vec_cast.vctrs_rational.vctrs_rational</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">to</span>, <span class="va">...</span><span class="op">)</span> <span class="va">x</span></span>
<span><span class="va">vec_cast.double.vctrs_rational</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">to</span>, <span class="va">...</span><span class="op">)</span> <span class="fu"><a href="../reference/fields.html">field</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"n"</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="../reference/fields.html">field</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"d"</span><span class="op">)</span></span>
<span><span class="va">vec_cast.vctrs_rational.integer</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">to</span>, <span class="va">...</span><span class="op">)</span> <span class="fu">rational</span><span class="op">(</span><span class="va">x</span>, <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/vec_c.html">vec_c</a></span><span class="op">(</span><span class="fu">rational</span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fl">1L</span>, <span class="cn">NA</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;rational[3]&gt;</span></span>
<span><span class="co">#&gt; [1] 1/2  1/1  &lt;NA&gt;</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="decimal2-class">Decimal2 class<a class="anchor" aria-label="anchor" href="#decimal2-class"></a>
</h3>
<p>The previous implementation of <code>decimal</code> was built on top
of doubles. This is a bad idea because decimal vectors are typically
used when you care about precise values (i.e., dollars and cents in a
bank account), and double values suffer from floating point
problems.</p>
<p>A better implementation of a decimal class would be to use pair of
integers, one for the value to the left of the decimal point, and the
other for the value to the right (divided by a <code>scale</code>). The
following code is a very quick sketch of how you might start creating
such a class:</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">new_decimal2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">l</span>, <span class="va">r</span>, <span class="va">scale</span> <span class="op">=</span> <span class="fl">2L</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rlang.r-lib.org/reference/type-predicates.html" class="external-link">is_integer</a></span><span class="op">(</span><span class="va">l</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rlang.r-lib.org/reference/abort.html" class="external-link">abort</a></span><span class="op">(</span><span class="st">"`l` must be an integer vector."</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rlang.r-lib.org/reference/type-predicates.html" class="external-link">is_integer</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rlang.r-lib.org/reference/abort.html" class="external-link">abort</a></span><span class="op">(</span><span class="st">"`r` must be an integer vector."</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rlang.r-lib.org/reference/type-predicates.html" class="external-link">is_integer</a></span><span class="op">(</span><span class="va">scale</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rlang.r-lib.org/reference/abort.html" class="external-link">abort</a></span><span class="op">(</span><span class="st">"`scale` must be an integer vector."</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="fu"><a href="../reference/vector-checks.html">vec_check_size</a></span><span class="op">(</span><span class="va">scale</span>, size <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="../reference/new_rcrd.html">new_rcrd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>l <span class="op">=</span> <span class="va">l</span>, r <span class="op">=</span> <span class="va">r</span><span class="op">)</span>, scale <span class="op">=</span> <span class="va">scale</span>, class <span class="op">=</span> <span class="st">"vctrs_decimal2"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">decimal2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">l</span>, <span class="va">r</span>, <span class="va">scale</span> <span class="op">=</span> <span class="fl">2L</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">l</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/vec_cast.html">vec_cast</a></span><span class="op">(</span><span class="va">l</span>, <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/vec_cast.html">vec_cast</a></span><span class="op">(</span><span class="va">r</span>, <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">l</span>, <span class="va">r</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/zeallot/man/operator.html" class="external-link">%&lt;-%</a></span> <span class="fu"><a href="../reference/vec_recycle.html">vec_recycle_common</a></span><span class="op">(</span><span class="va">l</span>, <span class="va">r</span><span class="op">)</span></span>
<span>  <span class="va">scale</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/vec_cast.html">vec_cast</a></span><span class="op">(</span><span class="va">scale</span>, <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># should check that r &lt; 10^scale</span></span>
<span>  <span class="fu">new_decimal2</span><span class="op">(</span>l <span class="op">=</span> <span class="va">l</span>, r <span class="op">=</span> <span class="va">r</span>, scale <span class="op">=</span> <span class="va">scale</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">format.vctrs_decimal2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">val</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fields.html">field</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"l"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="../reference/fields.html">field</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"r"</span><span class="op">)</span> <span class="op">/</span> <span class="fl">10</span><span class="op">^</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"scale"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"%.0"</span>, <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"scale"</span><span class="op">)</span>, <span class="st">"f"</span><span class="op">)</span>, <span class="va">val</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">decimal2</span><span class="op">(</span><span class="fl">10</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">5</span>, <span class="fl">99</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;vctrs_decimal2[3]&gt;</span></span>
<span><span class="co">#&gt; [1] 10.00 10.05 10.99</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="equality-and-comparison">Equality and comparison<a class="anchor" aria-label="anchor" href="#equality-and-comparison"></a>
</h2>
<p>vctrs provides four “proxy” generics. Two of these let you control
how your class determines equality and comparison:</p>
<ul>
<li><p><code><a href="../reference/vec_proxy_equal.html">vec_proxy_equal()</a></code> returns a data vector suitable for
comparison. It underpins <code>==</code>, <code>!=</code>,
<code><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique()</a></code>, <code><a href="https://rdrr.io/r/base/duplicated.html" class="external-link">anyDuplicated()</a></code>, and
<code><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na()</a></code>.</p></li>
<li><p><code><a href="../reference/vec_proxy_compare.html">vec_proxy_compare()</a></code> specifies how to compare the
elements of your vector. This proxy is used in <code>&lt;</code>,
<code>&lt;=</code>, <code>&gt;=</code>, <code>&gt;</code>,
<code><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min()</a></code>, <code><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max()</a></code>, <code><a href="https://rdrr.io/r/stats/median.html" class="external-link">median()</a></code>, and
<code><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile()</a></code>.</p></li>
</ul>
<p>Two other proxy generic are used for sorting for unordered data types
and for accessing the raw data for exotic storage formats:</p>
<ul>
<li>
<p><code><a href="../reference/vec_proxy_compare.html">vec_proxy_order()</a></code> specifies how to sort the elements
of your vector. It is used in <code><a href="https://rdrr.io/r/base/xtfrm.html" class="external-link">xtfrm()</a></code>, which in turn is
called by the <code><a href="https://rdrr.io/r/base/order.html" class="external-link">order()</a></code> and <code><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort()</a></code>
functions.</p>
<p>This proxy was added to implement the behaviour of lists, which are
sortable (their order proxy sorts by first occurrence) but not
comparable (comparison operators cause an error). Its default
implementation for other classes calls <code><a href="../reference/vec_proxy_compare.html">vec_proxy_compare()</a></code>
and you normally don’t need to implement this proxy.</p>
</li>
<li><p><code><a href="../reference/vec_proxy.html">vec_proxy()</a></code> returns the actual data of a vector.
This is useful when you store the data in a field of your class. Most of
the time, you shouldn’t need to implement
<code><a href="../reference/vec_proxy.html">vec_proxy()</a></code>.</p></li>
</ul>
<p>The default behavior is as follows:</p>
<ul>
<li>
<code><a href="../reference/vec_proxy_equal.html">vec_proxy_equal()</a></code> calls <code><a href="../reference/vec_proxy.html">vec_proxy()</a></code>
</li>
<li>
<code><a href="../reference/vec_proxy_compare.html">vec_proxy_compare()</a></code> calls
<code><a href="../reference/vec_proxy_equal.html">vec_proxy_equal()</a></code>
</li>
<li>
<code><a href="../reference/vec_proxy_compare.html">vec_proxy_order()</a></code> calls
<code><a href="../reference/vec_proxy_compare.html">vec_proxy_compare()</a></code>
</li>
</ul>
<p>You should only implement these proxies when some preprocessing on
the data is needed to make elements comparable. In that case, defining
these methods will get you a lot of behaviour for relatively little
work.</p>
<p>These proxy functions should always return a simple object (either a
bare vector or a data frame) that possesses the same properties as your
class. This permits efficient implementation of the vctrs internals
because it allows dispatch to happen once in R, and then efficient
computations can be written in C.</p>
<div class="section level3">
<h3 id="rational-class-1">Rational class<a class="anchor" aria-label="anchor" href="#rational-class-1"></a>
</h3>
<p>Let’s explore these ideas by with the rational class we started on
above. By default, <code><a href="../reference/vec_proxy.html">vec_proxy()</a></code> converts a record to a data
frame, and the default comparison works column by column:</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">rational</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">x</span></span>
<span><span class="co">#&gt; &lt;rational[4]&gt;</span></span>
<span><span class="co">#&gt; [1] 1/1 2/1 1/2 2/2</span></span>
<span></span>
<span><span class="fu"><a href="../reference/vec_proxy.html">vec_proxy</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt;   n d</span></span>
<span><span class="co">#&gt; 1 1 1</span></span>
<span><span class="co">#&gt; 2 2 1</span></span>
<span><span class="co">#&gt; 3 1 2</span></span>
<span><span class="co">#&gt; 4 2 2</span></span>
<span></span>
<span><span class="va">x</span> <span class="op">==</span> <span class="fu">rational</span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]  TRUE FALSE FALSE FALSE</span></span></code></pre></div>
<p>This makes sense as a default but isn’t correct here because
<code>rational(1, 1)</code> represents the same number as
<code>rational(2, 2)</code>, so they should be equal. We can fix that by
implementing a <code><a href="../reference/vec_proxy_equal.html">vec_proxy_equal()</a></code> method that divides
<code>n</code> and <code>d</code> by their greatest common divisor:</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Thanks to Matthew Lundberg: https://stackoverflow.com/a/21504113/16632</span></span>
<span><span class="va">gcd</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">r</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%%</a></span> <span class="va">y</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">r</span>, <span class="fu">gcd</span><span class="op">(</span><span class="va">y</span>, <span class="va">r</span><span class="op">)</span>, <span class="va">y</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">vec_proxy_equal.vctrs_rational</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fields.html">field</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"n"</span><span class="op">)</span></span>
<span>  <span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fields.html">field</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"d"</span><span class="op">)</span></span>
<span>  <span class="va">gcd</span> <span class="op">&lt;-</span> <span class="fu">gcd</span><span class="op">(</span><span class="va">n</span>, <span class="va">d</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">n</span> <span class="op">/</span> <span class="va">gcd</span>, d <span class="op">=</span> <span class="va">d</span> <span class="op">/</span> <span class="va">gcd</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="../reference/vec_proxy_equal.html">vec_proxy_equal</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt;   n d</span></span>
<span><span class="co">#&gt; 1 1 1</span></span>
<span><span class="co">#&gt; 2 2 1</span></span>
<span><span class="co">#&gt; 3 1 2</span></span>
<span><span class="co">#&gt; 4 1 1</span></span>
<span></span>
<span><span class="va">x</span> <span class="op">==</span> <span class="fu">rational</span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]  TRUE FALSE FALSE  TRUE</span></span></code></pre></div>
<p><code><a href="../reference/vec_proxy_equal.html">vec_proxy_equal()</a></code> is also used by
<code><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique()</a></code>:</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;rational[3]&gt;</span></span>
<span><span class="co">#&gt; [1] 1/1 2/1 1/2</span></span></code></pre></div>
<p>We now need to fix the comparison operations similarly, since
comparison currently happens lexicographically by <code>n</code>, then
by <code>d</code>:</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">rational</span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fu">rational</span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="fu">rational</span><span class="op">(</span><span class="fl">2</span>, <span class="fl">4</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fu">rational</span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>The easiest fix is to convert the fraction to a floating point number
and use this as a proxy:</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vec_proxy_compare.vctrs_rational</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/fields.html">field</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"n"</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="../reference/fields.html">field</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"d"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">rational</span><span class="op">(</span><span class="fl">2</span>, <span class="fl">4</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fu">rational</span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>This also fixes <code><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort()</a></code>, because the default
implementation of <code><a href="../reference/vec_proxy_compare.html">vec_proxy_order()</a></code> calls
<code><a href="../reference/vec_proxy_compare.html">vec_proxy_compare()</a></code>.</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;rational[4]&gt;</span></span>
<span><span class="co">#&gt; [1] 1/2 1/1 2/2 2/1</span></span></code></pre></div>
<p>(We could have used the same approach in
<code><a href="../reference/vec_proxy_equal.html">vec_proxy_equal()</a></code>, but when working with floating point
numbers it’s not necessarily true that <code>x == y</code> implies that
<code>d * x == d * y</code>.)</p>
</div>
<div class="section level3">
<h3 id="polynomial-class">Polynomial class<a class="anchor" aria-label="anchor" href="#polynomial-class"></a>
</h3>
<p>A related problem occurs if we build our vector on top of a list. The
following code defines a polynomial class that represents polynomials
(like <code>1 + 3x - 2x^2</code>) using a list of integer vectors (like
<code>c(1, 3, -2)</code>). Note the use of <code><a href="../reference/new_list_of.html">new_list_of()</a></code> in
the constructor.</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">poly</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/vec_cast.html">vec_cast_common</a></span><span class="op">(</span><span class="va">...</span>, .to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu">new_poly</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">new_poly</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/new_list_of.html">new_list_of</a></span><span class="op">(</span><span class="va">x</span>, ptype <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"vctrs_poly_list"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">vec_ptype_full.vctrs_poly_list</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="st">"polynomial"</span></span>
<span><span class="va">vec_ptype_abbr.vctrs_poly_list</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="st">"poly"</span></span>
<span></span>
<span><span class="va">format.vctrs_poly_list</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">format_one</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="va">suffix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"\u22C5x^"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>, <span class="st">""</span><span class="op">)</span></span>
<span>      <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">suffix</span><span class="op">)</span></span>
<span>      <span class="va">out</span> <span class="op">&lt;-</span> <span class="va">out</span><span class="op">[</span><span class="va">x</span> <span class="op">!=</span> <span class="fl">0L</span><span class="op">]</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">out</span>, collapse <span class="op">=</span> <span class="st">" + "</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">format_one</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">obj_print_data.vctrs_poly_list</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, quote <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/poly.html" class="external-link">poly</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">p</span></span>
<span><span class="co">#&gt; &lt;polynomial[3]&gt;</span></span>
<span><span class="co">#&gt; [1] 1         1⋅x^4 + 2 1⋅x^2 + 1</span></span></code></pre></div>
<p>The resulting objects will inherit from the
<code>vctrs_list_of</code> class, which provides tailored methods for
<code>$</code>, <code>[[</code>, the corresponding assignment operators,
and other methods.</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "vctrs_poly_list" "vctrs_list_of"   "vctrs_vctr"     </span></span>
<span><span class="co">#&gt; [4] "list"</span></span>
<span><span class="va">p</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span><span class="co">#&gt; &lt;polynomial[1]&gt;</span></span>
<span><span class="co">#&gt; [1] 1⋅x^4 + 2</span></span>
<span><span class="va">p</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] 1 0 0 0 2</span></span></code></pre></div>
<p>The class implements the list interface:</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/obj_is_list.html">obj_is_list</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>This is fine for the internal implementation of this class but it
would be more appropriate if it behaved like an atomic vector rather
than a list.</p>
<div class="section level4">
<h4 id="make-an-atomic-polynomial-vector">Make an atomic polynomial vector<a class="anchor" aria-label="anchor" href="#make-an-atomic-polynomial-vector"></a>
</h4>
<p>An atomic vector is a vector like integer or character for which
<code>[[</code> returns the same type. Unlike lists, you can’t reach
inside an atomic vector.</p>
<p>To make the polynomial class an atomic vector, we’ll wrap the
internal <code><a href="../reference/list_of.html">list_of()</a></code> class within a record vector. Usually
records are used because they can store several fields of data for each
observation. Here we have only one, but we use the class anyway to
inherit its atomicity.</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">poly</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/vec_cast.html">vec_cast_common</a></span><span class="op">(</span><span class="va">...</span>, .to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">new_poly</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/new_rcrd.html">new_rcrd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">x</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"vctrs_poly"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">format.vctrs_poly</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="../reference/fields.html">field</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"data"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The new <code><a href="https://rdrr.io/r/base/format.html" class="external-link">format()</a></code> method delegates to the one we wrote
for the internal list. The vector looks just like before:</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/poly.html" class="external-link">poly</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">p</span></span>
<span><span class="co">#&gt; &lt;vctrs_poly[3]&gt;</span></span>
<span><span class="co">#&gt; [1] 1         1⋅x^4 + 2 1⋅x^2 + 1</span></span></code></pre></div>
<p>Making the class atomic means that <code><a href="../reference/obj_is_list.html">obj_is_list()</a></code> now
returns <code>FALSE</code>. This prevents recursive algorithms that
traverse lists from reaching too far inside the polynomial
internals.</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/obj_is_list.html">obj_is_list</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span></code></pre></div>
<p>Most importantly, it prevents users from reaching into the internals
with <code>[[</code>:</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; &lt;vctrs_poly[1]&gt;</span></span>
<span><span class="co">#&gt; [1] 1⋅x^4 + 2</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="implementing-equality-and-comparison">Implementing equality and comparison<a class="anchor" aria-label="anchor" href="#implementing-equality-and-comparison"></a>
</h4>
<p>Equality works out of the box because we can tell if two integer
vectors are equal:</p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/stats/poly.html" class="external-link">poly</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE FALSE  TRUE</span></span></code></pre></div>
<p>We can’t compare individual elements, because the data is stored in a
list and by default lists are not comparable:</p>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">&lt;</span> <span class="va">p</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `vec_proxy_compare()`:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> `vec_proxy_compare.vctrs_poly_list()` not supported.</span></span></code></pre></div>
<p>To enable comparison, we implement a <code><a href="../reference/vec_proxy_compare.html">vec_proxy_compare()</a></code>
method:</p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vec_proxy_compare.vctrs_poly</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Get the list inside the record vector</span></span>
<span>  <span class="va">x_raw</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/vec_data.html">vec_data</a></span><span class="op">(</span><span class="fu"><a href="../reference/fields.html">field</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"data"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># First figure out the maximum length</span></span>
<span>  <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span><span class="va">x_raw</span>, <span class="va">length</span>, <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Then expand all vectors to this length by filling in with zeros</span></span>
<span>  <span class="va">full</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">x_raw</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0L</span>, <span class="va">n</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>, <span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Then turn into a data frame</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">full</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">p</span> <span class="op">&lt;</span> <span class="va">p</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1]  TRUE FALSE  TRUE</span></span></code></pre></div>
<p>Often, this is sufficient to also implement <code><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort()</a></code>.
However, for lists, there is already a default
<code><a href="../reference/vec_proxy_compare.html">vec_proxy_order()</a></code> method that sorts by first
occurrence:</p>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;vctrs_poly[3]&gt;</span></span>
<span><span class="co">#&gt; [1] 1         1⋅x^2 + 1 1⋅x^4 + 2</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">p</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;vctrs_poly[5]&gt;</span></span>
<span><span class="co">#&gt; [1] 1         1         1⋅x^2 + 1 1⋅x^4 + 2 1⋅x^4 + 2</span></span></code></pre></div>
<p>To ensure consistency between ordering and comparison, we forward
<code><a href="../reference/vec_proxy_compare.html">vec_proxy_order()</a></code> to <code><a href="../reference/vec_proxy_compare.html">vec_proxy_compare()</a></code>:</p>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vec_proxy_order.vctrs_poly</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/vec_proxy_compare.html">vec_proxy_compare</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;vctrs_poly[3]&gt;</span></span>
<span><span class="co">#&gt; [1] 1         1⋅x^2 + 1 1⋅x^4 + 2</span></span></code></pre></div>
</div>
</div>
</div>
<div class="section level2">
<h2 id="arithmetic">Arithmetic<a class="anchor" aria-label="anchor" href="#arithmetic"></a>
</h2>
<p>vctrs also provides two mathematical generics that allow you to
define a broad swath of mathematical behaviour at once:</p>
<ul>
<li><p><code>vec_math(fn, x, ...)</code> specifies the behaviour of
mathematical functions like <code><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs()</a></code>, <code><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum()</a></code>, and
<code><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean()</a></code>. (Note that <code><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var()</a></code> and <code><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd()</a></code>
can’t be overridden, see <code>?vec_math()</code> for the complete list
supported by <code><a href="../reference/vec_math.html">vec_math()</a></code>.)</p></li>
<li><p><code>vec_arith(op, x, y)</code> specifies the behaviour of the
arithmetic operations like <code>+</code>, <code>-</code>, and
<code>%%</code>. (See <code>?vec_arith()</code> for the complete
list.)</p></li>
</ul>
<p>Both generics define the behaviour for multiple functions because
<code>sum.vctrs_vctr(x)</code> calls
<code>vec_math.vctrs_vctr("sum", x)</code>, and <code>x + y</code> calls
<code>vec_math.x_class.y_class("+", x, y)</code>. They’re accompanied by
<code><a href="../reference/vec_math.html">vec_math_base()</a></code> and <code><a href="../reference/vec_arith.html">vec_arith_base()</a></code> which
make it easy to call the underlying base R functions.</p>
<p><code><a href="../reference/vec_arith.html">vec_arith()</a></code> uses double dispatch and needs the following
standard boilerplate:</p>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vec_arith.MYCLASS</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">op</span>, <span class="va">x</span>, <span class="va">y</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/UseMethod.html" class="external-link">UseMethod</a></span><span class="op">(</span><span class="st">"vec_arith.MYCLASS"</span>, <span class="va">y</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">vec_arith.MYCLASS.default</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">op</span>, <span class="va">x</span>, <span class="va">y</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/vctrs-conditions.html">stop_incompatible_op</a></span><span class="op">(</span><span class="va">op</span>, <span class="va">x</span>, <span class="va">y</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Correctly exporting <code><a href="../reference/vec_arith.html">vec_arith()</a></code> methods from a package
is currently a little awkward. See the instructions in the Arithmetic
section of the “Implementing a vctrs S3 class in a package” section
below.</p>
<div class="section level3">
<h3 id="cached-sum-class">Cached sum class<a class="anchor" aria-label="anchor" href="#cached-sum-class"></a>
</h3>
<p>I showed an example of <code><a href="../reference/vec_math.html">vec_math()</a></code> to define
<code><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum()</a></code> and <code><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean()</a></code> methods for
<code>cached_sum</code>. Now let’s talk about exactly how it works. Most
<code><a href="../reference/vec_math.html">vec_math()</a></code> functions will have a similar form. You use a
switch statement to handle the methods that you care about and fall back
to <code><a href="../reference/vec_math.html">vec_math_base()</a></code> for those that you don’t care about.</p>
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vec_math.vctrs_cached_sum</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">.fn</span>, <span class="va">.x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/switch.html" class="external-link">switch</a></span><span class="op">(</span><span class="va">.fn</span>,</span>
<span>    sum <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">.x</span>, <span class="st">"sum"</span><span class="op">)</span>,</span>
<span>    mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">.x</span>, <span class="st">"sum"</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/vec_math.html">vec_math_base</a></span><span class="op">(</span><span class="va">.fn</span>, <span class="va">.x</span>, <span class="va">...</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="meter-class">Meter class<a class="anchor" aria-label="anchor" href="#meter-class"></a>
</h3>
<p>To explore the infix arithmetic operators exposed by
<code><a href="../reference/vec_arith.html">vec_arith()</a></code> I’ll create a new class that represents a
measurement in <code>meter</code>s:</p>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">new_meter</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">is.double</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/new_vctr.html">new_vctr</a></span><span class="op">(</span><span class="va">x</span>, class <span class="op">=</span> <span class="st">"vctrs_meter"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">format.vctrs_meter</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="../reference/vec_data.html">vec_data</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>, <span class="st">" m"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">meter</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/vec_cast.html">vec_cast</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">double</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu">new_meter</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">meter</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">x</span></span>
<span><span class="co">#&gt; &lt;vctrs_meter[10]&gt;</span></span>
<span><span class="co">#&gt;  [1]  1 m  2 m  3 m  4 m  5 m  6 m  7 m  8 m  9 m 10 m</span></span></code></pre></div>
<p>Because <code>meter</code> is built on top of a double vector, basic
mathematic operations work:</p>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;vctrs_meter[1]&gt;</span></span>
<span><span class="co">#&gt; [1] 55 m</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;vctrs_meter[1]&gt;</span></span>
<span><span class="co">#&gt; [1] 5.5 m</span></span></code></pre></div>
<p>But we can’t do arithmetic:</p>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `vec_arith()`:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> &lt;vctrs_meter&gt; + &lt;double&gt; is not permitted</span></span>
<span><span class="fu">meter</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span> <span class="op">+</span> <span class="fu">meter</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `vec_arith()`:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> &lt;vctrs_meter&gt; + &lt;vctrs_meter&gt; is not permitted</span></span>
<span><span class="fu">meter</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span> <span class="op">*</span> <span class="fl">3</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `vec_arith()`:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> &lt;vctrs_meter&gt; * &lt;double&gt; is not permitted</span></span></code></pre></div>
<p>To allow these infix functions to work, we’ll need to provide
<code><a href="../reference/vec_arith.html">vec_arith()</a></code> generic. But before we do that, let’s think
about what combinations of inputs we should support:</p>
<ul>
<li><p>It makes sense to add and subtract meters: that yields another
meter. We can divide a meter by another meter (yielding a unitless
number), but we can’t multiply meters (because that would yield an
area).</p></li>
<li><p>For a combination of meter and number multiplication and division
by a number are acceptable. Addition and subtraction don’t make much
sense as we, strictly speaking, are dealing with objects of different
nature.</p></li>
</ul>
<p><code><a href="../reference/vec_arith.html">vec_arith()</a></code> is another function that uses double
dispatch, so as usual we start with a template.</p>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vec_arith.vctrs_meter</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">op</span>, <span class="va">x</span>, <span class="va">y</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/UseMethod.html" class="external-link">UseMethod</a></span><span class="op">(</span><span class="st">"vec_arith.vctrs_meter"</span>, <span class="va">y</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">vec_arith.vctrs_meter.default</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">op</span>, <span class="va">x</span>, <span class="va">y</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/vctrs-conditions.html">stop_incompatible_op</a></span><span class="op">(</span><span class="va">op</span>, <span class="va">x</span>, <span class="va">y</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Then write the method for two meter objects. We use a switch
statement to cover the cases we care about and
<code><a href="../reference/vctrs-conditions.html">stop_incompatible_op()</a></code> to throw an informative error
message for everything else.</p>
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vec_arith.vctrs_meter.vctrs_meter</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">op</span>, <span class="va">x</span>, <span class="va">y</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/switch.html" class="external-link">switch</a></span><span class="op">(</span></span>
<span>    <span class="va">op</span>,</span>
<span>    <span class="st">"+"</span> <span class="op">=</span> ,</span>
<span>    <span class="st">"-"</span> <span class="op">=</span> <span class="fu">new_meter</span><span class="op">(</span><span class="fu"><a href="../reference/vec_arith.html">vec_arith_base</a></span><span class="op">(</span><span class="va">op</span>, <span class="va">x</span>, <span class="va">y</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="st">"/"</span> <span class="op">=</span> <span class="fu"><a href="../reference/vec_arith.html">vec_arith_base</a></span><span class="op">(</span><span class="va">op</span>, <span class="va">x</span>, <span class="va">y</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/vctrs-conditions.html">stop_incompatible_op</a></span><span class="op">(</span><span class="va">op</span>, <span class="va">x</span>, <span class="va">y</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">meter</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span> <span class="op">+</span> <span class="fu">meter</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;vctrs_meter[1]&gt;</span></span>
<span><span class="co">#&gt; [1] 11 m</span></span>
<span><span class="fu">meter</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span> <span class="op">-</span> <span class="fu">meter</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;vctrs_meter[1]&gt;</span></span>
<span><span class="co">#&gt; [1] 9 m</span></span>
<span><span class="fu">meter</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span> <span class="op">/</span> <span class="fu">meter</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 10</span></span>
<span><span class="fu">meter</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span> <span class="op">*</span> <span class="fu">meter</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `vec_arith()`:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> &lt;vctrs_meter&gt; * &lt;vctrs_meter&gt; is not permitted</span></span></code></pre></div>
<p>Next we write the pair of methods for arithmetic with a meter and a
number. These are almost identical, but while <code>meter(10) / 2</code>
makes sense, <code>2 / meter(10)</code> does not (and neither do
addition and subtraction). To support both doubles and integers as
operands, we dispatch over <code>numeric</code> here instead of
<code>double</code>.</p>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vec_arith.vctrs_meter.numeric</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">op</span>, <span class="va">x</span>, <span class="va">y</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/switch.html" class="external-link">switch</a></span><span class="op">(</span></span>
<span>    <span class="va">op</span>,</span>
<span>    <span class="st">"/"</span> <span class="op">=</span> ,</span>
<span>    <span class="st">"*"</span> <span class="op">=</span> <span class="fu">new_meter</span><span class="op">(</span><span class="fu"><a href="../reference/vec_arith.html">vec_arith_base</a></span><span class="op">(</span><span class="va">op</span>, <span class="va">x</span>, <span class="va">y</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/vctrs-conditions.html">stop_incompatible_op</a></span><span class="op">(</span><span class="va">op</span>, <span class="va">x</span>, <span class="va">y</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">vec_arith.numeric.vctrs_meter</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">op</span>, <span class="va">x</span>, <span class="va">y</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/switch.html" class="external-link">switch</a></span><span class="op">(</span></span>
<span>    <span class="va">op</span>,</span>
<span>    <span class="st">"*"</span> <span class="op">=</span> <span class="fu">new_meter</span><span class="op">(</span><span class="fu"><a href="../reference/vec_arith.html">vec_arith_base</a></span><span class="op">(</span><span class="va">op</span>, <span class="va">x</span>, <span class="va">y</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/vctrs-conditions.html">stop_incompatible_op</a></span><span class="op">(</span><span class="va">op</span>, <span class="va">x</span>, <span class="va">y</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">meter</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span> <span class="op">*</span> <span class="fl">10</span></span>
<span><span class="co">#&gt; &lt;vctrs_meter[1]&gt;</span></span>
<span><span class="co">#&gt; [1] 20 m</span></span>
<span><span class="fu">meter</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;vctrs_meter[1]&gt;</span></span>
<span><span class="co">#&gt; [1] 20 m</span></span>
<span><span class="fl">10</span> <span class="op">*</span> <span class="fu">meter</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;vctrs_meter[1]&gt;</span></span>
<span><span class="co">#&gt; [1] 20 m</span></span>
<span><span class="fu">meter</span><span class="op">(</span><span class="fl">20</span><span class="op">)</span> <span class="op">/</span> <span class="fl">10</span></span>
<span><span class="co">#&gt; &lt;vctrs_meter[1]&gt;</span></span>
<span><span class="co">#&gt; [1] 2 m</span></span>
<span><span class="fl">10</span> <span class="op">/</span> <span class="fu">meter</span><span class="op">(</span><span class="fl">20</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `vec_arith()`:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> &lt;double&gt; / &lt;vctrs_meter&gt; is not permitted</span></span>
<span><span class="fu">meter</span><span class="op">(</span><span class="fl">20</span><span class="op">)</span> <span class="op">+</span> <span class="fl">10</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `vec_arith()`:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> &lt;vctrs_meter&gt; + &lt;double&gt; is not permitted</span></span></code></pre></div>
<p>For completeness, we also need
<code>vec_arith.vctrs_meter.MISSING</code> for the unary <code>+</code>
and <code>-</code> operators:</p>
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vec_arith.vctrs_meter.MISSING</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">op</span>, <span class="va">x</span>, <span class="va">y</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/switch.html" class="external-link">switch</a></span><span class="op">(</span><span class="va">op</span>,</span>
<span>    `-` <span class="op">=</span> <span class="va">x</span> <span class="op">*</span> <span class="op">-</span><span class="fl">1</span>,</span>
<span>    `+` <span class="op">=</span> <span class="va">x</span>,</span>
<span>    <span class="fu"><a href="../reference/vctrs-conditions.html">stop_incompatible_op</a></span><span class="op">(</span><span class="va">op</span>, <span class="va">x</span>, <span class="va">y</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="op">-</span><span class="fu">meter</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;vctrs_meter[1]&gt;</span></span>
<span><span class="co">#&gt; [1] -1 m</span></span>
<span><span class="op">+</span><span class="fu">meter</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;vctrs_meter[1]&gt;</span></span>
<span><span class="co">#&gt; [1] 1 m</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="implementing-a-vctrs-s3-class-in-a-package">Implementing a vctrs S3 class in a package<a class="anchor" aria-label="anchor" href="#implementing-a-vctrs-s3-class-in-a-package"></a>
</h2>
<p>Defining S3 methods interactively is fine for iteration and
exploration, but if your class lives in a package, you need to do a few
more things:</p>
<ul>
<li><p>Register the S3 methods by listing them in the
<code>NAMESPACE</code> file.</p></li>
<li><p>Create documentation around your methods, for the sake of your
user and to satisfy <code>R CMD check</code>.</p></li>
</ul>
<p>Let’s assume that the <code>percent</code> class is implemented in
the pizza package in the file <code>R/percent.R</code>. Here we walk
through the major sections of this hypothetical file. You’ve seen all of
this code before, but now it’s augmented by the roxygen2 directives that
produce the correct <code>NAMESPACE</code> entries and help topics.</p>
<div class="section level3">
<h3 id="getting-started">Getting started<a class="anchor" aria-label="anchor" href="#getting-started"></a>
</h3>
<p>First, the pizza package needs to include vctrs in the
<code>Imports</code> section of its <code>DESCRIPTION</code> (perhaps by
calling <code>usethis::use_package("vctrs")</code>. While vctrs is under
very active development, it probably makes sense to state a minimum
version.</p>
<pre><code>Imports:
    a_package,
    another_package,
    ...
    vctrs (&gt;= x.y.z),
    ...</code></pre>
<p>Then we make all vctrs functions available within the pizza package
by including the directive <code>#' @import vctrs</code> somewhere.
Usually, it’s not good practice to <code>@import</code> the entire
namespace of a package, but vctrs is deliberately designed with this use
case in mind.</p>
<p>Where should we put <code>#' @import vctrs</code>? There are two
natural locations:</p>
<ul>
<li><p>With package-level docs in <code>R/pizza-doc.R</code>. You can
use <code>usethis::use_package_doc()</code> to initiate this
package-level documentation.</p></li>
<li><p>In <code>R/percent.R</code>. This makes the most sense when the
vctrs S3 class is a modest and self-contained part of the overall
package.</p></li>
</ul>
<p>We also must use one of these locations to dump some internal
documentation that’s needed to avoid <code>R CMD check</code>
complaints. We don’t expect any human to ever read this documentation.
Here’s how this dummy documentation should look, combined with the
<code>#' @import vctrs</code> directive described above.</p>
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Internal vctrs methods</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @import vctrs</span></span>
<span><span class="co">#' @keywords internal</span></span>
<span><span class="co">#' @name pizza-vctrs</span></span>
<span><span class="cn">NULL</span></span></code></pre></div>
<p>This should appear in <code>R/pizza-doc.R</code> (package-level docs)
or in <code>R/percent.R</code> (class-focused file).</p>
<p>Remember to call <code>devtools::document()</code> regularly, as you
develop, to regenerate <code>NAMESPACE</code> and the <code>.Rd</code>
files.</p>
<p>From this point on, the code shown is expected to appear in
<code>R/percent.R</code>.</p>
</div>
<div class="section level3">
<h3 id="low-level-and-user-friendly-constructors">Low-level and user-friendly constructors<a class="anchor" aria-label="anchor" href="#low-level-and-user-friendly-constructors"></a>
</h3>
<p>Next we add our constructor:</p>
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">new_percent</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">double</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rlang.r-lib.org/reference/type-predicates.html" class="external-link">is_double</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rlang.r-lib.org/reference/abort.html" class="external-link">abort</a></span><span class="op">(</span><span class="st">"`x` must be a double vector."</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="fu"><a href="../reference/new_vctr.html">new_vctr</a></span><span class="op">(</span><span class="va">x</span>, class <span class="op">=</span> <span class="st">"pizza_percent"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Note that the name of the package must be included in the class name
(<code>pizza_percent</code>), but it does not need to be included in the
constructor name. You do not need to export the constructor, unless you
want people to extend your class.</p>
<p>We can also add a call to <code>setOldClass()</code> for
compatibility with S4:</p>
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># for compatibility with the S4 system</span></span>
<span><span class="fu">methods</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/methods/setOldClass.html" class="external-link">setOldClass</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"pizza_percent"</span>, <span class="st">"vctrs_vctr"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Because we’ve used a function from the methods package, you’ll also
need to add methods to <code>Imports</code>, with (e.g.)
<code>usethis::use_package("methods")</code>. This is a “free”
dependency because methods is bundled with every R install.</p>
<p>Next we implement, export, and document a user-friendly helper:
<code>percent()</code>.</p>
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' `percent` vector</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' This creates a double vector that represents percentages so when it is</span></span>
<span><span class="co">#' printed, it is multiplied by 100 and suffixed with `%`.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param x A numeric vector</span></span>
<span><span class="co">#' @return An S3 vector of class `pizza_percent`.</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="co">#' @examples</span></span>
<span><span class="co">#' percent(c(0.25, 0.5, 0.75))</span></span>
<span><span class="va">percent</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">double</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/vec_cast.html">vec_cast</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">double</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu">new_percent</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>(Again note that the package name will appear in the class, but does
not need to occur in the function, because we can already do
<code>pizza::percent()</code>; it would be redundant to have
<code>pizza::pizza_percent()</code>.)</p>
</div>
<div class="section level3">
<h3 id="other-helpers">Other helpers<a class="anchor" aria-label="anchor" href="#other-helpers"></a>
</h3>
<p>It’s a good idea to provide a function that tests if an object is of
this class. If you do so, it makes sense to document it with the
user-friendly constructor <code>percent()</code>:</p>
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @export</span></span>
<span><span class="co">#' @rdname percent</span></span>
<span><span class="va">is_percent</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"pizza_percent"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>You’ll also need to update the <code>percent()</code> documentation
to reflect that <code>x</code> now means two different things:</p>
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @param x</span></span>
<span><span class="co">#'  * For `percent()`: A numeric vector</span></span>
<span><span class="co">#'  * For `is_percent()`: An object to test.</span></span></code></pre></div>
<p>Next we provide the key methods to make printing work. These are S3
methods, so they don’t need to be documented, but they do need to be
exported.</p>
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @export</span></span>
<span><span class="va">format.pizza_percent</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/formatc.html" class="external-link">formatC</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">signif</a></span><span class="op">(</span><span class="fu"><a href="../reference/vec_data.html">vec_data</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">out</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span>  <span class="va">out</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">out</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">]</span>, <span class="st">"%"</span><span class="op">)</span></span>
<span>  <span class="va">out</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#' @export</span></span>
<span><span class="va">vec_ptype_abbr.pizza_percent</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="st">"prcnt"</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Finally, we implement methods for <code><a href="../reference/vec_ptype2.html">vec_ptype2()</a></code> and
<code><a href="../reference/vec_cast.html">vec_cast()</a></code>.</p>
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @export</span></span>
<span><span class="va">vec_ptype2.vctrs_percent.vctrs_percent</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">...</span><span class="op">)</span> <span class="fu">new_percent</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="va">vec_ptype2.double.vctrs_percent</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">...</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">double</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' @export</span></span>
<span><span class="va">vec_cast.pizza_percent.pizza_percent</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">to</span>, <span class="va">...</span><span class="op">)</span> <span class="va">x</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="va">vec_cast.pizza_percent.double</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">to</span>, <span class="va">...</span><span class="op">)</span> <span class="fu">percent</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="va">vec_cast.double.pizza_percent</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">to</span>, <span class="va">...</span><span class="op">)</span> <span class="fu"><a href="../reference/vec_data.html">vec_data</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="arithmetic-1">Arithmetic<a class="anchor" aria-label="anchor" href="#arithmetic-1"></a>
</h3>
<p>Writing double dispatch methods for <code><a href="../reference/vec_arith.html">vec_arith()</a></code> is
currently more awkward than writing them for <code><a href="../reference/vec_ptype2.html">vec_ptype2()</a></code>
or <code><a href="../reference/vec_cast.html">vec_cast()</a></code>. We plan to improve this in the future. For
now, you can use the following instructions.</p>
<p>If you define a new type and want to write <code><a href="../reference/vec_arith.html">vec_arith()</a></code>
methods for it, you’ll need to provide a new single dispatch S3 generic
for it of the following form:</p>
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @export</span></span>
<span><span class="co">#' @method vec_arith my_type</span></span>
<span><span class="va">vec_arith.my_type</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">op</span>, <span class="va">x</span>, <span class="va">y</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/UseMethod.html" class="external-link">UseMethod</a></span><span class="op">(</span><span class="st">"vec_arith.my_type"</span>, <span class="va">y</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Note that this actually functions as both an S3 method for
<code><a href="../reference/vec_arith.html">vec_arith()</a></code> and an S3 generic called
<code>vec_arith.my_type()</code> that dispatches off <code>y</code>.
roxygen2 only recognizes it as an S3 generic, so you have to register
the S3 method part of this with an explicit <code>@method</code>
call.</p>
<p>After that, you can define double dispatch methods, but you still
need an explicit <code>@method</code> tag to ensure it is registered
with the correct generic:</p>
<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @export</span></span>
<span><span class="co">#' @method vec_arith.my_type my_type</span></span>
<span><span class="va">vec_arith.my_type.my_type</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">op</span>, <span class="va">x</span>, <span class="va">y</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># implementation here</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#' @export</span></span>
<span><span class="co">#' @method vec_arith.my_type integer</span></span>
<span><span class="va">vec_arith.my_type.integer</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">op</span>, <span class="va">x</span>, <span class="va">y</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># implementation here</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#' @export</span></span>
<span><span class="co">#' @method vec_arith.integer my_type</span></span>
<span><span class="va">vec_arith.integer.my_type</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">op</span>, <span class="va">x</span>, <span class="va">y</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># implementation here</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>vctrs provides the hybrid S3 generics/methods for most of the base R
types, like <code>vec_arith.integer()</code>. If you don’t fully import
vctrs with <code>@import vctrs</code>, then you will need to explicitly
import the generic you are registering double dispatch methods for with
<code>@importFrom vctrs vec_arith.integer</code>.</p>
</div>
<div class="section level3">
<h3 id="testing">Testing<a class="anchor" aria-label="anchor" href="#testing"></a>
</h3>
<p>It’s good practice to test your new class. Specific
recommendations:</p>
<ul>
<li><p><code>R/percent.R</code> is the type of file where you really do
want 100% test coverage. You can use
<code>devtools::test_coverage_file()</code> to check this.</p></li>
<li><p>Make sure to test behaviour with zero-length inputs and missing
values.</p></li>
<li><p>Use <code><a href="https://testthat.r-lib.org/reference/verify_output.html" class="external-link">testthat::verify_output()</a></code> to test your format
method. Customised printing is often a primary motivation for creating
your own S3 class in the first place, so this will alert you to
unexpected changes in your printed output. Read more about
<code>verify_output()</code> in the <a href="https://www.tidyverse.org/blog/2019/11/testthat-2-3-0/" class="external-link">testthat
v2.3.0 blog post</a>; it’s an example of a so-called <a href="https://ro-che.info/articles/2017-12-04-golden-tests" class="external-link">golden
test</a>.</p></li>
<li><p>Check for method symmetry; use <code>expect_s3_class()</code>,
probably with <code>exact = TRUE</code>, to ensure that
<code>vec_c(x, y)</code> and <code>vec_c(y, x)</code> return the same
type of output for the important <code>x</code>s and <code>y</code>s in
your domain.</p></li>
<li>
<p>Use <code><a href="https://testthat.r-lib.org/reference/expect_error.html" class="external-link">testthat::expect_error()</a></code> to check that inputs
that can’t be combined fail with an error. Here, you should be generally
checking the class of the error, not its message. Relevant classes
include <code>vctrs_error_assert_ptype</code>,
<code>vctrs_error_assert_size</code>, and
<code>vctrs_error_incompatible_type</code>.</p>
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">expect_error</span><span class="op">(</span><span class="fu"><a href="../reference/vec_c.html">vec_c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="st">"a"</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"vctrs_error_incompatible_type"</span><span class="op">)</span></span></code></pre></div>
</li>
</ul>
<p>If your tests pass when run by <code>devtools::test()</code>, but
fail when run in <code>R CMD check</code>, it is very likely to reflect
a problem with S3 method registration. Carefully check your roxygen2
comments and the generated <code>NAMESPACE</code>.</p>
</div>
<div class="section level3">
<h3 id="existing-classes">Existing classes<a class="anchor" aria-label="anchor" href="#existing-classes"></a>
</h3>
<p>Before you build your own class, you might want to consider using, or
subclassing existing classes. You can check <a href="https://github.com/krlmlr/awesome-vctrs" class="external-link">awesome-vctrs</a> for a
curated list of R vector classes, some of which are built with
vctrs.</p>
<p>If you’ve built or extended a class, consider adding it to that list
so other people can use it.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p></p>
<p>Developed by <a href="http://hadley.nz" class="external-link">Hadley Wickham</a>, <a href="https://github.com/lionel-" class="external-link">Lionel Henry</a>, <a href="https://github.com/DavisVaughan" class="external-link">Davis Vaughan</a>, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

  </div></footer>
</body>
</html>

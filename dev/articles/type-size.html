<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Prototypes and sizes • vctrs</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.9/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.9/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Prototypes and sizes">
<meta name="robots" content="noindex">
<script defer data-domain="vctrs.r-lib.org,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">vctrs</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.6.5.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/pillar.html">Printing vectors nicely in tibbles</a></li>
    <li><a class="dropdown-item" href="../articles/s3-vector.html">S3 vectors</a></li>
    <li><a class="dropdown-item" href="../articles/stability.html">Type and size stability</a></li>
    <li><a class="dropdown-item" href="../articles/type-size.html">Prototypes and sizes</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/r-lib/vctrs/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Prototypes and sizes</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/vctrs/blob/main/vignettes/type-size.Rmd" class="external-link"><code>vignettes/type-size.Rmd</code></a></small>
      <div class="d-none name"><code>type-size.Rmd</code></div>
    </div>

    
    
<p>Rather than using <code><a href="https://rdrr.io/r/base/class.html" class="external-link">class()</a></code> and <code><a href="https://rdrr.io/r/base/length.html" class="external-link">length()</a></code>,
vctrs has notions of prototype (<code><a href="../reference/vec_ptype.html">vec_ptype_show()</a></code>) and size
(<code><a href="../reference/vec_size.html">vec_size()</a></code>). This vignette discusses the motivation for
why these alternatives are necessary and connects their definitions to
type coercion and the recycling rules.</p>
<p>Size and prototype are motivated by thinking about the optimal
behaviour for <code><a href="https://rdrr.io/r/base/c.html" class="external-link">c()</a></code> and <code><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind()</a></code>, particularly
inspired by data frames with columns that are matrices or data
frames.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://vctrs.r-lib.org/">vctrs</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="prototype">Prototype<a class="anchor" aria-label="anchor" href="#prototype"></a>
</h2>
<p>The idea of a prototype is to capture the metadata associated with a
vector without capturing any data. Unfortunately, the
<code><a href="https://rdrr.io/r/base/class.html" class="external-link">class()</a></code> of an object is inadequate for this purpose:</p>
<ul>
<li><p>The <code><a href="https://rdrr.io/r/base/class.html" class="external-link">class()</a></code> doesn’t include attributes. Attributes
are important because, for example, they store the levels of a factor
and the timezone of a <code>POSIXct</code>. You cannot combine two
factors or two <code>POSIXct</code>s without thinking about the
attributes.</p></li>
<li><p>The <code><a href="https://rdrr.io/r/base/class.html" class="external-link">class()</a></code> of a matrix is “matrix” and doesn’t
include the type of the underlying vector or the
dimensionality.</p></li>
</ul>
<p>Instead, vctrs takes advantage of R’s vectorised nature and uses a
<strong>prototype</strong>, a 0-observation slice of the vector (this is
basically <code>x[0]</code> but with some subtleties we’ll come back to
later). This is a miniature version of the vector that contains all of
the attributes but none of the data.</p>
<p>Conveniently, you can create many prototypes using existing base
functions (e.g, <code><a href="https://rdrr.io/r/base/double.html" class="external-link">double()</a></code> and
<code>factor(levels = c("a", "b"))</code>). vctrs provides a few helpers
(e.g. <code><a href="../reference/new_date.html">new_date()</a></code>, <code><a href="../reference/new_date.html">new_datetime()</a></code>, and
<code><a href="../reference/new_date.html">new_duration()</a></code>) where the equivalents in base R are
missing.</p>
<div class="section level3">
<h3 id="base-prototypes">Base prototypes<a class="anchor" aria-label="anchor" href="#base-prototypes"></a>
</h3>
<p><code><a href="../reference/vec_ptype.html">vec_ptype()</a></code> creates a prototype from an existing object.
However, many base vectors have uninformative printing methods for
0-length subsets, so vctrs also provides <code><a href="../reference/vec_ptype.html">vec_ptype_show()</a></code>,
which prints the prototype in a friendly way (and returns nothing).</p>
<p>Using <code><a href="../reference/vec_ptype.html">vec_ptype_show()</a></code> allows us to see the prototypes
base R classes:</p>
<ul>
<li>
<p>Atomic vectors have no attributes and just display the underlying
<code><a href="https://rdrr.io/r/base/typeof.html" class="external-link">typeof()</a></code>:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/vec_ptype.html">vec_ptype_show</a></span><span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Prototype: logical</span></span>
<span><span class="fu"><a href="../reference/vec_ptype.html">vec_ptype_show</a></span><span class="op">(</span><span class="fl">1L</span><span class="op">)</span></span>
<span><span class="co">#&gt; Prototype: integer</span></span>
<span><span class="fu"><a href="../reference/vec_ptype.html">vec_ptype_show</a></span><span class="op">(</span><span class="fl">2.5</span><span class="op">)</span></span>
<span><span class="co">#&gt; Prototype: double</span></span>
<span><span class="fu"><a href="../reference/vec_ptype.html">vec_ptype_show</a></span><span class="op">(</span><span class="st">"three"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Prototype: character</span></span>
<span><span class="fu"><a href="../reference/vec_ptype.html">vec_ptype_show</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Prototype: list</span></span></code></pre></div>
</li>
<li>
<p>The prototype of matrices and arrays include the base type and
the dimensions after the first:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/vec_ptype.html">vec_ptype_show</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">logical</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Prototype: logical[,3]</span></span>
<span><span class="fu"><a href="../reference/vec_ptype.html">vec_ptype_show</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Prototype: integer[,3,4]</span></span>
<span><span class="fu"><a href="../reference/vec_ptype.html">vec_ptype_show</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">4</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Prototype: character[,3,4,5]</span></span></code></pre></div>
</li>
<li>
<p>The prototype of a factor includes its levels. Levels are a
character vector, which can be arbitrarily long, so the prototype just
shows a hash. If the hash of two factors is equal, it’s highly likely
that their levels are also equal.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/vec_ptype.html">vec_ptype_show</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="st">"a"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Prototype: factor&lt;4d52a&gt;</span></span>
<span><span class="fu"><a href="../reference/vec_ptype.html">vec_ptype_show</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">ordered</a></span><span class="op">(</span><span class="st">"b"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Prototype: ordered&lt;9b7e3&gt;</span></span></code></pre></div>
<p>While <code><a href="../reference/vec_ptype.html">vec_ptype_show()</a></code> prints only the hash, the
prototype object itself does contain all levels:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/vec_ptype.html">vec_ptype</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="st">"a"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; factor()</span></span>
<span><span class="co">#&gt; Levels: a</span></span></code></pre></div>
</li>
<li>
<p>Base R has three key date time classes: dates, date-times
(<code>POSIXct</code>), and durations (<code>difftime)</code>.
Date-times have a timezone, and durations have a unit.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/vec_ptype.html">vec_ptype_show</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.Date</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Prototype: date</span></span>
<span><span class="fu"><a href="../reference/vec_ptype.html">vec_ptype_show</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Prototype: datetime&lt;local&gt;</span></span>
<span><span class="fu"><a href="../reference/vec_ptype.html">vec_ptype_show</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/difftime.html" class="external-link">as.difftime</a></span><span class="op">(</span><span class="fl">10</span>, units <span class="op">=</span> <span class="st">"mins"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Prototype: duration&lt;mins&gt;</span></span></code></pre></div>
</li>
<li>
<p>Data frames have the most complex prototype: the prototype of a
data frame is the name and prototype of each column:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/vec_ptype.html">vec_ptype_show</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>a <span class="op">=</span> <span class="cn">FALSE</span>, b <span class="op">=</span> <span class="fl">1L</span>, c <span class="op">=</span> <span class="fl">2.5</span>, d <span class="op">=</span> <span class="st">"x"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Prototype: data.frame&lt;</span></span>
<span><span class="co">#&gt;   a: logical</span></span>
<span><span class="co">#&gt;   b: integer</span></span>
<span><span class="co">#&gt;   c: double</span></span>
<span><span class="co">#&gt;   d: character</span></span>
<span><span class="co">#&gt; &gt;</span></span></code></pre></div>
<p>Data frames can have columns that are themselves data frames, making
this a “recursive” type:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">df</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fl">1L</span>, b <span class="op">=</span> <span class="fl">2.5</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/vec_ptype.html">vec_ptype_show</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span>
<span><span class="co">#&gt; Prototype: data.frame&lt;</span></span>
<span><span class="co">#&gt;   x: logical</span></span>
<span><span class="co">#&gt;   y: </span></span>
<span><span class="co">#&gt;     data.frame&lt;</span></span>
<span><span class="co">#&gt;       a: integer</span></span>
<span><span class="co">#&gt;       b: double</span></span>
<span><span class="co">#&gt;     &gt;</span></span>
<span><span class="co">#&gt; &gt;</span></span></code></pre></div>
</li>
</ul>
</div>
<div class="section level3">
<h3 id="coercing-to-common-type">Coercing to common type<a class="anchor" aria-label="anchor" href="#coercing-to-common-type"></a>
</h3>
<p>It’s often important to combine vectors with multiple types. vctrs
provides a consistent set of rules for coercion, via
<code><a href="../reference/vec_ptype.html">vec_ptype_common()</a></code>. <code><a href="../reference/vec_ptype.html">vec_ptype_common()</a></code>
possesses the following invariants:</p>
<ul>
<li><p><code>class(vec_ptype_common(x, y))</code> equals
<code>class(vec_ptype_common(y, x))</code>.</p></li>
<li><p><code>class(vec_ptype_common(x, vec_ptype_common(y, z))</code>
equals
<code>class(vec_ptype_common(vec_ptype_common(x, y), z))</code>.</p></li>
<li><p><code>vec_ptype_common(x, NULL) == vec_ptype(x)</code>.</p></li>
</ul>
<p>i.e., <code><a href="../reference/vec_ptype.html">vec_ptype_common()</a></code> is both commutative and
associative (with respect to class) and has an identity element,
<code>NULL</code>; i.e., it’s a <strong>commutative monoid</strong>.
This means the underlying implementation is quite simple: we can find
the common type of any number of objects by progressively finding the
common type of pairs of objects.</p>
<p>Like with <code><a href="../reference/vec_ptype.html">vec_ptype()</a></code>, the easiest way to explore
<code><a href="../reference/vec_ptype.html">vec_ptype_common()</a></code> is with <code><a href="../reference/vec_ptype.html">vec_ptype_show()</a></code>:
when given multiple inputs, it will print their common prototype. (In
other words: program with <code><a href="../reference/vec_ptype.html">vec_ptype_common()</a></code> but play with
<code><a href="../reference/vec_ptype.html">vec_ptype_show()</a></code>.)</p>
<ul>
<li>
<p>The common type of atomic vectors is computed very similar to the
rules of base R, except that we do not coerce to character
automatically:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/vec_ptype.html">vec_ptype_show</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">logical</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">double</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Prototype: &lt;double&gt;</span></span>
<span><span class="co">#&gt; 0. (           , &lt;logical&gt; ) = &lt;logical&gt;</span></span>
<span><span class="co">#&gt; 1. ( &lt;logical&gt; , &lt;integer&gt; ) = &lt;integer&gt;</span></span>
<span><span class="co">#&gt; 2. ( &lt;integer&gt; , &lt;double&gt;  ) = &lt;double&gt;</span></span>
<span></span>
<span><span class="fu"><a href="../reference/vec_ptype.html">vec_ptype_show</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">logical</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `vec_ptype_show()`:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> Can't combine `out_types[[i - 1]]` &lt;logical&gt; and `in_types[[i]]` &lt;character&gt;.</span></span></code></pre></div>
</li>
<li>
<p>Matrices and arrays are automatically broadcast to higher
dimensions:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/vec_ptype.html">vec_ptype_show</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>, </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Prototype: &lt;double[,2]&gt;</span></span>
<span><span class="co">#&gt; 0. (              , &lt;double[,1]&gt; ) = &lt;double[,1]&gt;</span></span>
<span><span class="co">#&gt; 1. ( &lt;double[,1]&gt; , &lt;double[,2]&gt; ) = &lt;double[,2]&gt;</span></span>
<span></span>
<span><span class="fu"><a href="../reference/vec_ptype.html">vec_ptype_show</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>, </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3</span>, <span class="fl">4</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Prototype: &lt;double[,3,4,5]&gt;</span></span>
<span><span class="co">#&gt; 0. (                , &lt;double[,1]&gt;     ) = &lt;double[,1]&gt;    </span></span>
<span><span class="co">#&gt; 1. ( &lt;double[,1]&gt;   , &lt;double[,3]&gt;     ) = &lt;double[,3]&gt;    </span></span>
<span><span class="co">#&gt; 2. ( &lt;double[,3]&gt;   , &lt;double[,3,4]&gt;   ) = &lt;double[,3,4]&gt;  </span></span>
<span><span class="co">#&gt; 3. ( &lt;double[,3,4]&gt; , &lt;double[,3,4,5]&gt; ) = &lt;double[,3,4,5]&gt;</span></span></code></pre></div>
<p>Provided that the dimensions follow the vctrs recycling rules:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/vec_ptype.html">vec_ptype_show</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>, </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;">:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> Can't combine `out_types[[i - 1]]` &lt;double[,2]&gt; and `in_types[[i]]` &lt;double[,3]&gt;.</span></span>
<span><span class="co">#&gt; <span style="color: #BB0000;">✖</span> Incompatible sizes 2 and 3 along axis 2.</span></span></code></pre></div>
</li>
<li>
<p>Factors combine levels in the order in which they appear.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fa</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="st">"a"</span><span class="op">)</span></span>
<span><span class="va">fb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="st">"b"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="fu"><a href="../reference/vec_ptype.html">vec_ptype_common</a></span><span class="op">(</span><span class="va">fa</span>, <span class="va">fb</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "a" "b"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="fu"><a href="../reference/vec_ptype.html">vec_ptype_common</a></span><span class="op">(</span><span class="va">fb</span>, <span class="va">fa</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "b" "a"</span></span></code></pre></div>
</li>
<li>
<p>Combining a date and date-time yields a date-time:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/vec_ptype.html">vec_ptype_show</a></span><span class="op">(</span><span class="fu"><a href="../reference/new_date.html">new_date</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="../reference/new_date.html">new_datetime</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Prototype: &lt;datetime&lt;local&gt;&gt;</span></span>
<span><span class="co">#&gt; 0. (        , &lt;date&gt;            ) = &lt;date&gt;           </span></span>
<span><span class="co">#&gt; 1. ( &lt;date&gt; , &lt;datetime&lt;local&gt;&gt; ) = &lt;datetime&lt;local&gt;&gt;</span></span></code></pre></div>
<p>When combining two date times, the timezone is taken from the first
input:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/vec_ptype.html">vec_ptype_show</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/new_date.html">new_datetime</a></span><span class="op">(</span>tzone <span class="op">=</span> <span class="st">"US/Central"</span><span class="op">)</span>, </span>
<span>  <span class="fu"><a href="../reference/new_date.html">new_datetime</a></span><span class="op">(</span>tzone <span class="op">=</span> <span class="st">"Pacific/Auckland"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Prototype: &lt;datetime&lt;US/Central&gt;&gt;</span></span>
<span><span class="co">#&gt; 0. (                        , &lt;datetime&lt;US/Central&gt;&gt;       ) = &lt;datetime&lt;US/Central&gt;&gt;</span></span>
<span><span class="co">#&gt; 1. ( &lt;datetime&lt;US/Central&gt;&gt; , &lt;datetime&lt;Pacific/Auckland&gt;&gt; ) = &lt;datetime&lt;US/Central&gt;&gt;</span></span></code></pre></div>
<p>Unless it’s the local timezone, in which case any explicit time zone
will win:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/vec_ptype.html">vec_ptype_show</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/new_date.html">new_datetime</a></span><span class="op">(</span>tzone <span class="op">=</span> <span class="st">""</span><span class="op">)</span>, </span>
<span>  <span class="fu"><a href="../reference/new_date.html">new_datetime</a></span><span class="op">(</span>tzone <span class="op">=</span> <span class="st">""</span><span class="op">)</span>, </span>
<span>  <span class="fu"><a href="../reference/new_date.html">new_datetime</a></span><span class="op">(</span>tzone <span class="op">=</span> <span class="st">"Pacific/Auckland"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Prototype: &lt;datetime&lt;Pacific/Auckland&gt;&gt;</span></span>
<span><span class="co">#&gt; 0. (                   , &lt;datetime&lt;local&gt;&gt;            ) = &lt;datetime&lt;local&gt;&gt;           </span></span>
<span><span class="co">#&gt; 1. ( &lt;datetime&lt;local&gt;&gt; , &lt;datetime&lt;local&gt;&gt;            ) = &lt;datetime&lt;local&gt;&gt;           </span></span>
<span><span class="co">#&gt; 2. ( &lt;datetime&lt;local&gt;&gt; , &lt;datetime&lt;Pacific/Auckland&gt;&gt; ) = &lt;datetime&lt;Pacific/Auckland&gt;&gt;</span></span></code></pre></div>
</li>
<li>
<p>The common type of two data frames is the common type of each
column that occurs in both data frames:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/vec_ptype.html">vec_ptype_show</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">2.5</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Prototype: &lt;data.frame&lt;x:double&gt;&gt;</span></span>
<span><span class="co">#&gt; 0. (                         , &lt;data.frame&lt;x:logical&gt;&gt; ) = &lt;data.frame&lt;x:logical&gt;&gt;</span></span>
<span><span class="co">#&gt; 1. ( &lt;data.frame&lt;x:logical&gt;&gt; , &lt;data.frame&lt;x:integer&gt;&gt; ) = &lt;data.frame&lt;x:integer&gt;&gt;</span></span>
<span><span class="co">#&gt; 2. ( &lt;data.frame&lt;x:integer&gt;&gt; , &lt;data.frame&lt;x:double&gt;&gt;  ) = &lt;data.frame&lt;x:double&gt;&gt;</span></span></code></pre></div>
<p>And the union of the columns that only occur in one:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/vec_ptype.html">vec_ptype_show</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span>, y <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fl">1</span>, z <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Prototype: &lt;data.frame&lt;</span></span>
<span><span class="co">#&gt;   x: double</span></span>
<span><span class="co">#&gt;   y: double</span></span>
<span><span class="co">#&gt;   z: double</span></span>
<span><span class="co">#&gt; &gt;&gt;</span></span>
<span><span class="co">#&gt; 0. ┌              , &lt;data.frame&lt; ┐ = &lt;data.frame&lt;</span></span>
<span><span class="co">#&gt;    │                  x: double  │     x: double </span></span>
<span><span class="co">#&gt;    │                  y: double  │     y: double </span></span>
<span><span class="co">#&gt;    └                &gt;&gt;           ┘   &gt;&gt;          </span></span>
<span><span class="co">#&gt; 1. ┌ &lt;data.frame&lt; , &lt;data.frame&lt; ┐ = &lt;data.frame&lt;</span></span>
<span><span class="co">#&gt;    │   x: double      y: double  │     x: double </span></span>
<span><span class="co">#&gt;    │   y: double      z: double  │     y: double </span></span>
<span><span class="co">#&gt;    │ &gt;&gt;             &gt;&gt;           │     z: double </span></span>
<span><span class="co">#&gt;    └                             ┘   &gt;&gt;</span></span></code></pre></div>
<p>Note that new columns are added on the right-hand side. This is
consistent with the way that factor levels and time zones are
handled.</p>
</li>
</ul>
</div>
<div class="section level3">
<h3 id="casting-to-specified-type">Casting to specified type<a class="anchor" aria-label="anchor" href="#casting-to-specified-type"></a>
</h3>
<p><code><a href="../reference/vec_ptype.html">vec_ptype_common()</a></code> finds the common type of a set of
vector. Typically, however, what you want is a set of vectors coerced to
that common type. That’s the job of <code><a href="../reference/vec_cast.html">vec_cast_common()</a></code>:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="fu"><a href="../reference/vec_cast.html">vec_cast_common</a></span><span class="op">(</span></span>
<span>  <span class="cn">FALSE</span>, </span>
<span>  <span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, </span>
<span>  <span class="fl">2.5</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 3</span></span>
<span><span class="co">#&gt;  $ : num 0</span></span>
<span><span class="co">#&gt;  $ : num [1:5] 1 2 3 4 5</span></span>
<span><span class="co">#&gt;  $ : num 2.5</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="fu"><a href="../reference/vec_cast.html">vec_cast_common</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="st">"x"</span><span class="op">)</span>, </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="st">"y"</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 2</span></span>
<span><span class="co">#&gt;  $ : Factor w/ 2 levels "x","y": 1</span></span>
<span><span class="co">#&gt;  $ : Factor w/ 2 levels "x","y": 2</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="fu"><a href="../reference/vec_cast.html">vec_cast_common</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 2</span></span>
<span><span class="co">#&gt;  $ :'data.frame':    1 obs. of  2 variables:</span></span>
<span><span class="co">#&gt;   ..$ x: num 1</span></span>
<span><span class="co">#&gt;   ..$ y: int NA</span></span>
<span><span class="co">#&gt;  $ :'data.frame':    2 obs. of  2 variables:</span></span>
<span><span class="co">#&gt;   ..$ x: num [1:2] NA NA</span></span>
<span><span class="co">#&gt;   ..$ y: int [1:2] 1 2</span></span></code></pre></div>
<p>Alternatively, you can cast to a specific prototype using
<code><a href="../reference/vec_cast.html">vec_cast()</a></code>:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Cast succeeds</span></span>
<span><span class="fu"><a href="../reference/vec_cast.html">vec_cast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1 2</span></span>
<span></span>
<span><span class="co"># Cast fails</span></span>
<span><span class="fu"><a href="../reference/vec_cast.html">vec_cast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.5</span>, <span class="fl">2.5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="st">"a"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;">:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> Can't convert `c(1.5, 2.5)` &lt;double&gt; to &lt;factor&lt;4d52a&gt;&gt;.</span></span></code></pre></div>
<p>If a cast is possible in general (i.e., double -&gt; integer), but
information is lost for a specific input (e.g. 1.5 -&gt; 1), it will
generate an error.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/vec_cast.html">vec_cast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.5</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;">:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> Can't convert from `c(1.5, 2)` &lt;double&gt; to &lt;integer&gt; due to loss of precision.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> Locations: 1</span></span></code></pre></div>
<p>You can suppress the lossy cast errors with
<code><a href="../reference/vctrs-conditions.html">allow_lossy_cast()</a></code>:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/vctrs-conditions.html">allow_lossy_cast</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/vec_cast.html">vec_cast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.5</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1 2</span></span></code></pre></div>
<p>This will suppress all lossy cast errors. Supply prototypes if you
want to be specific about the type of lossy cast allowed:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/vctrs-conditions.html">allow_lossy_cast</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/vec_cast.html">vec_cast</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.5</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  x_ptype <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">double</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  to_ptype <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1 2</span></span></code></pre></div>
<p>The set of casts should not be more permissive than the set of
coercions. This is not enforced but it is expected from classes to
follow the rule and keep the coercion ecosystem sound.</p>
</div>
</div>
<div class="section level2">
<h2 id="size">Size<a class="anchor" aria-label="anchor" href="#size"></a>
</h2>
<p><code><a href="../reference/vec_size.html">vec_size()</a></code> was motivated by the need to have an
invariant that describes the number of “observations” in a data
structure. This is particularly important for data frames, as it’s
useful to have some function such that <code>f(data.frame(x))</code>
equals <code>f(x)</code>. No base function has this property:</p>
<ul>
<li><p><code>length(data.frame(x))</code> equals <code>1</code> because
the length of a data frame is the number of columns.</p></li>
<li><p><code>nrow(data.frame(x))</code> does not equal
<code>nrow(x)</code> because <code><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow()</a></code> of a vector is
<code>NULL</code>.</p></li>
<li><p><code>NROW(data.frame(x))</code> equals <code>NROW(x)</code> for
vector <code>x</code>, so is almost what we want. But because
<code><a href="https://rdrr.io/r/base/nrow.html" class="external-link">NROW()</a></code> is defined in terms of <code><a href="https://rdrr.io/r/base/length.html" class="external-link">length()</a></code>, it
returns a value for every object, even types that can’t go in a data
frame, e.g. <code>data.frame(mean)</code> errors even though
<code>NROW(mean)</code> is <code>1</code>.</p></li>
</ul>
<p>We define <code><a href="../reference/vec_size.html">vec_size()</a></code> as follows:</p>
<ul>
<li>It is the length of 1d vectors.</li>
<li>It is the number of rows of data frames, matrices, and arrays.</li>
<li>It throws error for non vectors.</li>
</ul>
<p>Given <code><a href="../reference/vec_size.html">vec_size()</a></code>, we can give a precise definition of a
data frame: a data frame is a list of vectors where every vector has the
same size. This has the desirable property of trivially supporting
matrix and data frame columns.</p>
<div class="section level3">
<h3 id="slicing">Slicing<a class="anchor" aria-label="anchor" href="#slicing"></a>
</h3>
<p><code><a href="../reference/vec_slice.html">vec_slice()</a></code> is to <code><a href="../reference/vec_size.html">vec_size()</a></code> as
<code>[</code> is to <code><a href="https://rdrr.io/r/base/length.html" class="external-link">length()</a></code>; i.e., it allows you to
select observations regardless of the dimensionality of the underlying
object. <code>vec_slice(x, i)</code> is equivalent to:</p>
<ul>
<li>
<code>x[i]</code> when <code>x</code> is a vector.</li>
<li>
<code>x[i, , drop = FALSE]</code> when <code>x</code> is a data
frame.</li>
<li>
<code>x[i, , , drop = FALSE]</code> when <code>x</code> is a 3d
array.</li>
</ul>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/vec_slice.html">vec_slice</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">5</span><span class="op">:</span><span class="fl">6</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 4 1</span></span>
<span><span class="fu"><a href="../reference/vec_slice.html">vec_slice</a></span><span class="op">(</span><span class="va">df</span>, <span class="fl">5</span><span class="op">:</span><span class="fl">6</span><span class="op">)</span></span>
<span><span class="co">#&gt;   x</span></span>
<span><span class="co">#&gt; 1 4</span></span>
<span><span class="co">#&gt; 2 1</span></span></code></pre></div>
<p><code>vec_slice(data.frame(x), i)</code> equals
<code>data.frame(vec_slice(x, i))</code> (modulo variable and row
names).</p>
<p>Prototypes are generated with <code>vec_slice(x, 0L)</code>; given a
prototype, you can initialize a vector of given size (filled with
<code>NA</code>s) with <code><a href="../reference/vec_init.html">vec_init()</a></code>.</p>
</div>
<div class="section level3">
<h3 id="common-sizes-recycling-rules">Common sizes: recycling rules<a class="anchor" aria-label="anchor" href="#common-sizes-recycling-rules"></a>
</h3>
<p>Closely related to the definition of size are the <strong>recycling
rules</strong>. The recycling rules determine the size of the output
when two vectors of different sizes are combined. In vctrs, the
recycling rules are encoded in <code><a href="../reference/vec_size.html">vec_size_common()</a></code>, which
gives the common size of a set of vectors:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/vec_size.html">vec_size_common</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 3</span></span>
<span><span class="fu"><a href="../reference/vec_size.html">vec_size_common</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 10</span></span>
<span><span class="fu"><a href="../reference/vec_size.html">vec_size_common</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0</span></span></code></pre></div>
<p>vctrs obeys a stricter set of recycling rules than base R. Vectors of
size 1 are recycled to any other size. All other size combinations will
generate an error. This strictness prevents common mistakes like
<code>dest == c("IAH", "HOU"))</code>, at the cost of occasionally
requiring an explicit calls to <code><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep()</a></code>.</p>
<div class="float">
<img src="../reference/figures/sizes-recycling.png" alt="Summary of vctrs recycling rules. X indicates an error"><div class="figcaption">Summary of vctrs recycling rules. X indicates an
error</div>
</div>
<p>You can apply the recycling rules in two ways:</p>
<ul>
<li>
<p>If you have a vector and desired size, use
<code><a href="../reference/vec_recycle.html">vec_recycle()</a></code>:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/vec_recycle.html">vec_recycle</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1 2 3</span></span>
<span><span class="fu"><a href="../reference/vec_recycle.html">vec_recycle</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] 1 1 1 1 1 1 1 1 1 1</span></span></code></pre></div>
</li>
<li>
<p>If you have multiple vectors and you want to recycle them to the
same size, use <code><a href="../reference/vec_recycle.html">vec_recycle_common()</a></code>:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/vec_recycle.html">vec_recycle_common</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; [1] 1 2 3</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; [1] 1 2 3</span></span>
<span><span class="fu"><a href="../reference/vec_recycle.html">vec_recycle_common</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt;  [1]  1  2  3  4  5  6  7  8  9 10</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt;  [1] 1 1 1 1 1 1 1 1 1 1</span></span></code></pre></div>
</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="appendix-recycling-in-base-r">Appendix: recycling in base R<a class="anchor" aria-label="anchor" href="#appendix-recycling-in-base-r"></a>
</h2>
<p>The recycling rules in base R are described in <a href="https://cran.r-project.org/doc/manuals/r-release/R-lang.html#Recycling-rules" class="external-link">The
R Language Definition</a> but are not implemented in a single function
and thus are not applied consistently. Here, I give a brief overview of
their most common realisation, as well as showing some of the
exceptions.</p>
<p>Generally, in base R, when a pair of vectors is not the same length,
the shorter vector is recycled to the same length as the longer:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">6</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="co">#&gt; [1] 2 2 2 2 2 2</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">6</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span></span>
<span><span class="co">#&gt; [1] 2 3 2 3 2 3</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">6</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span></span>
<span><span class="co">#&gt; [1] 2 3 4 2 3 4</span></span></code></pre></div>
<p>If the length of the longer vector is not an integer multiple of the
length of the shorter, you usually get a warning:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in pmax(1:2, 1:3): an argument will be fractionally recycled</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span> <span class="op">+</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in 1:2 + 1:3: longer object length is not a multiple of shorter</span></span>
<span><span class="co">#&gt; object length</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in cbind(1:2, 1:3): number of rows of result is not a multiple of</span></span>
<span><span class="co">#&gt; vector length (arg 1)</span></span></code></pre></div>
<p>But some functions recycle silently:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">atan2</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 3</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 3</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 3</span></span></code></pre></div>
<p>And <code><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame()</a></code> throws an error:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in data.frame(1:2, 1:3): arguments imply differing number of rows: 2, 3</span></span></code></pre></div>
<p>The R language definition states that “any arithmetic operation
involving a zero-length vector has a zero-length result”. But outside of
arithmetic, this rule is not consistently followed:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># length-0 output</span></span>
<span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; integer(0)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">atan2</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; numeric(0)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmax</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; integer(0)</span></span>
<span></span>
<span><span class="co"># dropped</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;      [,1]</span></span>
<span><span class="co">#&gt; [1,]    1</span></span>
<span><span class="co">#&gt; [2,]    2</span></span>
<span></span>
<span><span class="co"># recycled to length of first</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">TRUE</span>, <span class="fl">4</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] NA NA NA NA</span></span>
<span></span>
<span><span class="co"># preserved-ish</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "1 " "2 "</span></span>
<span></span>
<span><span class="co"># Errors</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">integer</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in data.frame(1:2, integer()): arguments imply differing number of rows: 2, 0</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by <a href="https://hadley.nz" class="external-link">Hadley Wickham</a>, <a href="https://github.com/lionel-" class="external-link">Lionel Henry</a>, <a href="https://github.com/DavisVaughan" class="external-link">Davis Vaughan</a>, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" width="62" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

  </div></footer>
</body>
</html>

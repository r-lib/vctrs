<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Proxy and restore — vec_proxy • vctrs</title><!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png"><link rel="icon" type="”image/svg+xml”" href="../favicon.svg"><link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png"><link rel="icon" sizes="any" href="../favicon.ico"><link rel="manifest" href="../site.webmanifest"><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.10/font.css" rel="stylesheet"><link href="../deps/Source_Code_Pro-0.4.10/font.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Proxy and restore — vec_proxy"><meta name="description" content="
vec_proxy() returns the data structure containing the values of a
vector. This data structure is usually the vector itself. In this
case the proxy is the identity function, which is
the default vec_proxy() method.
Only experts should implement special vec_proxy() methods, for
these cases:
A vector has vectorised attributes, i.e. metadata for
each element of the vector. These record types are implemented
in vctrs by returning a data frame in the proxy method. If you're
starting your class from scratch, consider deriving from the
rcrd class. It implements the appropriate data
frame proxy and is generally the preferred way to create a record
class.
When you're implementing a vector on top of a non-vector type,
like an environment or an S4 object. This is currently only
partially supported.
S3 lists are considered scalars by default. This is the safe
choice for list objects such as returned by stats::lm(). To
declare that your S3 list class is a vector, you normally add
&quot;list&quot; to the right of your class vector. Explicit inheritance
from list is generally the preferred way to declare an S3 list in
R, for instance it makes it possible to dispatch on
generic.list S3 methods.
If you can't modify your class vector, you can implement an
identity proxy (i.e. a proxy method that just returns its input)
to let vctrs know this is a vector list and not a scalar.


vec_restore() is the inverse operation of vec_proxy(). It
should only be called on vector proxies.
It undoes the transformations of vec_proxy().
It restores attributes and classes. These may be lost when the
memory values are manipulated. For example slicing a subset of a
vector's proxy causes a new proxy to be allocated.


By default vctrs restores all attributes and classes
automatically. You only need to implement a vec_restore() method
if your class has attributes that depend on the data."><meta property="og:description" content="
vec_proxy() returns the data structure containing the values of a
vector. This data structure is usually the vector itself. In this
case the proxy is the identity function, which is
the default vec_proxy() method.
Only experts should implement special vec_proxy() methods, for
these cases:
A vector has vectorised attributes, i.e. metadata for
each element of the vector. These record types are implemented
in vctrs by returning a data frame in the proxy method. If you're
starting your class from scratch, consider deriving from the
rcrd class. It implements the appropriate data
frame proxy and is generally the preferred way to create a record
class.
When you're implementing a vector on top of a non-vector type,
like an environment or an S4 object. This is currently only
partially supported.
S3 lists are considered scalars by default. This is the safe
choice for list objects such as returned by stats::lm(). To
declare that your S3 list class is a vector, you normally add
&quot;list&quot; to the right of your class vector. Explicit inheritance
from list is generally the preferred way to declare an S3 list in
R, for instance it makes it possible to dispatch on
generic.list S3 methods.
If you can't modify your class vector, you can implement an
identity proxy (i.e. a proxy method that just returns its input)
to let vctrs know this is a vector list and not a scalar.


vec_restore() is the inverse operation of vec_proxy(). It
should only be called on vector proxies.
It undoes the transformations of vec_proxy().
It restores attributes and classes. These may be lost when the
memory values are manipulated. For example slicing a subset of a
vector's proxy causes a new proxy to be allocated.


By default vctrs restores all attributes and classes
automatically. You only need to implement a vec_restore() method
if your class has attributes that depend on the data."><meta property="og:image" content="https://vctrs.r-lib.org/logo.png"><meta name="robots" content="noindex"><script defer data-domain="vctrs.r-lib.org,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script></head><body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">vctrs</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.6.5.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/pillar.html">Printing vectors nicely in tibbles</a></li>
    <li><a class="dropdown-item" href="../articles/s3-vector.html">S3 vectors</a></li>
    <li><a class="dropdown-item" href="../articles/stability.html">Type and size stability</a></li>
    <li><a class="dropdown-item" href="../articles/type-size.html">Prototypes and sizes</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/r-lib/vctrs/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic" id="container">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Proxy and restore</h1>
      <small class="dont-index">Source: <a href="https://github.com/r-lib/vctrs/blob/main/R/proxy.R" class="external-link"><code>R/proxy.R</code></a></small>
      <div class="d-none name"><code>vec_proxy.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p><a href="https://lifecycle.r-lib.org/articles/stages.html#experimental" class="external-link"><img src="figures/lifecycle-experimental.svg" alt="[Experimental]"></a></p>
<p><code>vec_proxy()</code> returns the data structure containing the values of a
vector. This data structure is usually the vector itself. In this
case the proxy is the <a href="https://rdrr.io/r/base/identity.html" class="external-link">identity function</a>, which is
the default <code>vec_proxy()</code> method.</p>
<p>Only experts should implement special <code>vec_proxy()</code> methods, for
these cases:</p><ul><li><p>A vector has vectorised attributes, i.e. metadata for
each element of the vector. These <em>record types</em> are implemented
in vctrs by returning a data frame in the proxy method. If you're
starting your class from scratch, consider deriving from the
<code><a href="new_rcrd.html">rcrd</a></code> class. It implements the appropriate data
frame proxy and is generally the preferred way to create a record
class.</p></li>
<li><p>When you're implementing a vector on top of a non-vector type,
like an environment or an S4 object. This is currently only
partially supported.</p></li>
<li><p>S3 lists are considered scalars by default. This is the safe
choice for list objects such as returned by <code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">stats::lm()</a></code>. To
declare that your S3 list class is a vector, you normally add
<code>"list"</code> to the right of your class vector. Explicit inheritance
from list is generally the preferred way to declare an S3 list in
R, for instance it makes it possible to dispatch on
<code>generic.list</code> S3 methods.</p>
<p>If you can't modify your class vector, you can implement an
identity proxy (i.e. a proxy method that just returns its input)
to let vctrs know this is a vector list and not a scalar.</p></li>
</ul><p><code>vec_restore()</code> is the inverse operation of <code>vec_proxy()</code>. It
should only be called on vector proxies.</p><ul><li><p>It undoes the transformations of <code>vec_proxy()</code>.</p></li>
<li><p>It restores attributes and classes. These may be lost when the
memory values are manipulated. For example slicing a subset of a
vector's proxy causes a new proxy to be allocated.</p></li>
</ul><p>By default vctrs restores all attributes and classes
automatically. You only need to implement a <code>vec_restore()</code> method
if your class has attributes that depend on the data.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">vec_proxy</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">vec_restore</span><span class="op">(</span><span class="va">x</span>, <span class="va">to</span>, <span class="va">...</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-x">x<a class="anchor" aria-label="anchor" href="#arg-x"></a></dt>
<dd><p>A vector.</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>These dots are for future extensions and must be empty.</p></dd>


<dt id="arg-to">to<a class="anchor" aria-label="anchor" href="#arg-to"></a></dt>
<dd><p>The original vector to restore to.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="proxying">Proxying<a class="anchor" aria-label="anchor" href="#proxying"></a></h2>



<p>You should only implement <code>vec_proxy()</code> when your type is designed
around a non-vector class. I.e. anything that is not either:</p><ul><li><p>An atomic vector</p></li>
<li><p>A bare list</p></li>
<li><p>A data frame</p></li>
</ul><p>In this case, implement <code>vec_proxy()</code> to return such a vector
class. The vctrs operations such as <code><a href="vec_slice.html">vec_slice()</a></code> are applied on
the proxy and <code>vec_restore()</code> is called to restore the original
representation of your type.</p>
<p>The most common case where you need to implement <code>vec_proxy()</code> is
for S3 lists. In vctrs, S3 lists are treated as scalars by
default. This way we don't treat objects like model fits as
vectors. To prevent vctrs from treating your S3 list as a scalar,
unclass it in the <code>vec_proxy()</code> method. For instance, here is the
definition for <code>list_of</code>:</p>
<p></p><div class="sourceCode"><pre><code><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a>vec_proxy.vctrs_list_of <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>  <span class="fu">unclass</span>(x)</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>}</span></code></pre><p></p></div>
<p>Another case where you need to implement a proxy is <a href="new_rcrd.html">record types</a>. Record types should return a data frame, as in
the <code>POSIXlt</code> method:</p>
<p></p><div class="sourceCode"><pre><code><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a>vec_proxy.POSIXlt <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>  <span class="fu">new_data_frame</span>(<span class="fu">unclass</span>(x))</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>}</span></code></pre><p></p></div>
<p>Note that you don't need to implement <code>vec_proxy()</code> when your class
inherits from <code>vctrs_vctr</code> or <code>vctrs_rcrd</code>.</p>
    </div>
    <div class="section level2">
    <h2 id="restoring">Restoring<a class="anchor" aria-label="anchor" href="#restoring"></a></h2>



<p>A restore is a specialised type of cast, primarily used in
conjunction with <code><a href="https://rdrr.io/r/base/UseMethod.html" class="external-link">NextMethod()</a></code> or a C-level function that works on
the underlying data structure. A <code>vec_restore()</code> method can make
the following assumptions about <code>x</code>:</p><ul><li><p>It has the correct type.</p></li>
<li><p>It has the correct names.</p></li>
<li><p>It has the correct <code>dim</code> and <code>dimnames</code> attributes.</p></li>
<li><p>It is unclassed. This way you can call vctrs generics with <code>x</code>
without triggering an infinite loop of restoration.</p></li>
</ul><p>The length may be different (for example after <code><a href="vec_slice.html">vec_slice()</a></code> has
been called), and all other attributes may have been lost. The
method should restore all attributes so that after restoration,
<code>vec_restore(vec_data(x), x)</code> yields <code>x</code>.</p>
<p>To understand the difference between <code><a href="vec_cast.html">vec_cast()</a></code> and <code>vec_restore()</code>
think about factors: it doesn't make sense to cast an integer to a factor,
but if <code><a href="https://rdrr.io/r/base/UseMethod.html" class="external-link">NextMethod()</a></code> or another low-level function has stripped attributes,
you still need to be able to restore them.</p>
<p>The default method copies across all attributes so you only need to
provide your own method if your attributes require special care
(i.e. they are dependent on the data in some way). When implementing
your own method, bear in mind that many R users add attributes to track
additional metadata that is important to them, so you should preserve any
attributes that don't require special handling for your class.</p>
    </div>
    <div class="section level2">
    <h2 id="dependencies">Dependencies<a class="anchor" aria-label="anchor" href="#dependencies"></a></h2>


<ul><li><p><code>x</code> must be a vector in the vctrs sense (see <code><a href="vec_assert.html">vec_is()</a></code>)</p></li>
<li><p>By default the underlying data is returned as is (identity proxy)</p></li>
</ul><p>All vector classes have a proxy, even those who don't implement any
vctrs methods. The exception is S3 lists that don't inherit from
<code>"list"</code> explicitly. These might have to implement an identity
proxy for compatibility with vctrs (see discussion above).</p>
    </div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by <a href="https://hadley.nz" class="external-link">Hadley Wickham</a>, <a href="https://github.com/lionel-" class="external-link">Lionel Henry</a>, <a href="https://github.com/DavisVaughan" class="external-link">Davis Vaughan</a>, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" width="62" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

  </div></footer></body></html>


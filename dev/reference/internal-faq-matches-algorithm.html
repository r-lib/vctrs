<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="description" content="vec_locate_matches() is similar to vec_match(), but detects all matches by default, and can match on conditions other than equality (like &amp;gt;= and &amp;lt;). There are also various other arguments to limit or adjust exactly which kinds of matches are returned. Here is an example:
x &amp;lt;- c(&quot;a&quot;, &quot;b&quot;, &quot;a&quot;, &quot;c&quot;, &quot;d&quot;)
y &amp;lt;- c(&quot;d&quot;, &quot;b&quot;, &quot;a&quot;, &quot;d&quot;, &quot;a&quot;, &quot;e&quot;)

# For each value of `x`, find all matches in `y`
# - The &quot;c&quot; in `x` doesn't have a match, so it gets an NA location by default
# - The &quot;e&quot; in `y` isn't matched by anything in `x`, so it is dropped by default
vec_locate_matches(x, y)
#&amp;gt;   needles haystack
#&amp;gt; 1       1        3
#&amp;gt; 2       1        5
#&amp;gt; 3       2        2
#&amp;gt; 4       3        3
#&amp;gt; 5       3        5
#&amp;gt; 6       4       NA
#&amp;gt; 7       5        1
#&amp;gt; 8       5        4
"><title>Internal FAQ - Implementation of vec_locate_matches() — internal-faq-matches-algorithm • vctrs</title><!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png"><link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png"><link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png"><link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png"><link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png"><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.9/font.css" rel="stylesheet"><link href="../deps/Source_Code_Pro-0.4.9/font.css" rel="stylesheet"><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Internal FAQ - Implementation of vec_locate_matches() — internal-faq-matches-algorithm"><meta property="og:description" content="vec_locate_matches() is similar to vec_match(), but detects all matches by default, and can match on conditions other than equality (like &amp;gt;= and &amp;lt;). There are also various other arguments to limit or adjust exactly which kinds of matches are returned. Here is an example:
x &amp;lt;- c(&quot;a&quot;, &quot;b&quot;, &quot;a&quot;, &quot;c&quot;, &quot;d&quot;)
y &amp;lt;- c(&quot;d&quot;, &quot;b&quot;, &quot;a&quot;, &quot;d&quot;, &quot;a&quot;, &quot;e&quot;)

# For each value of `x`, find all matches in `y`
# - The &quot;c&quot; in `x` doesn't have a match, so it gets an NA location by default
# - The &quot;e&quot; in `y` isn't matched by anything in `x`, so it is dropped by default
vec_locate_matches(x, y)
#&amp;gt;   needles haystack
#&amp;gt; 1       1        3
#&amp;gt; 2       1        5
#&amp;gt; 3       2        2
#&amp;gt; 4       3        3
#&amp;gt; 5       3        5
#&amp;gt; 6       4       NA
#&amp;gt; 7       5        1
#&amp;gt; 8       5        4
"><meta property="og:image" content="https://vctrs.r-lib.org/logo.png"><meta name="robots" content="noindex"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><script defer data-domain="vctrs.r-lib.org,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script></head><body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-none" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">vctrs</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.6.5.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/pillar.html">Printing vectors nicely in tibbles</a>
    <a class="dropdown-item" href="../articles/s3-vector.html">S3 vectors</a>
    <a class="dropdown-item" href="../articles/stability.html">Type and size stability</a>
    <a class="dropdown-item" href="../articles/type-size.html">Prototypes and sizes</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul><form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off"></form>

      <ul class="navbar-nav"><li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/r-lib/vctrs/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div>

    
  </div>
</nav><div class="container template-reference-topic" id="container">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Internal FAQ - Implementation of <code>vec_locate_matches()</code></h1>
      <small class="dont-index">Source: <a href="https://github.com/r-lib/vctrs/blob/HEAD/R/match.R" class="external-link"><code>R/match.R</code></a></small>
      <div class="d-none name"><code>internal-faq-matches-algorithm.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p><code><a href="vec_locate_matches.html">vec_locate_matches()</a></code> is similar to <code><a href="vec_match.html">vec_match()</a></code>, but detects <em>all</em> matches by default, and can match on conditions other than equality (like <code>&gt;=</code> and <code>&lt;</code>). There are also various other arguments to limit or adjust exactly which kinds of matches are returned. Here is an example:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"a"</span>, <span class="st">"c"</span>, <span class="st">"d"</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"d"</span>, <span class="st">"b"</span>, <span class="st">"a"</span>, <span class="st">"d"</span>, <span class="st">"a"</span>, <span class="st">"e"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># For each value of `x`, find all matches in `y`</span></span>
<span><span class="co"># - The "c" in `x` doesn't have a match, so it gets an NA location by default</span></span>
<span><span class="co"># - The "e" in `y` isn't matched by anything in `x`, so it is dropped by default</span></span>
<span><span class="fu"><a href="../reference/vec_locate_matches.html">vec_locate_matches</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span></span>
<span><span class="co">#&gt;   needles haystack</span></span>
<span><span class="co">#&gt; 1       1        3</span></span>
<span><span class="co">#&gt; 2       1        5</span></span>
<span><span class="co">#&gt; 3       2        2</span></span>
<span><span class="co">#&gt; 4       3        3</span></span>
<span><span class="co">#&gt; 5       3        5</span></span>
<span><span class="co">#&gt; 6       4       NA</span></span>
<span><span class="co">#&gt; 7       5        1</span></span>
<span><span class="co">#&gt; 8       5        4</span></span></code></pre><p></p></div>
    </div>


    <div class="section level2">
    <h2 id="algorithm-description">Algorithm description<a class="anchor" aria-label="anchor" href="#algorithm-description"></a></h2>
    
<div class="section">
<h3 id="overview-and-">Overview and <code>==</code><a class="anchor" aria-label="anchor" href="#overview-and-"></a></h3>


<p>The simplest (approximate) way to think about the algorithm that <code>df_locate_matches_recurse()</code> uses is that it sorts both inputs, and then starts at the midpoint in <code>needles</code> and uses a binary search to find each needle in <code>haystack</code>. Since there might be multiple of the same needle, we find the location of the lower and upper duplicate of that needle to handle all duplicates of that needle at once. Similarly, if there are duplicates of a matching <code>haystack</code> value, we find the lower and upper duplicates of the match.</p>
<p>If the condition is <code>==</code>, that is pretty much all we have to do. For each needle, we then record 3 things: the location of the needle, the location of the lower match in the haystack, and the match size (i.e. <code>loc_upper_match - loc_lower_match + 1</code>). This later gets expanded in <code>expand_compact_indices()</code> into the actual output.</p>
<p>After recording the matches for a single needle, we perform the same procedure on the LHS and RHS of that needle (remember we started on the midpoint needle). i.e. from <code>[1, loc_needle-1]</code> and <code>[loc_needle+1, size_needles]</code>, again taking the midpoint of those two ranges, finding their respective needle in the haystack, recording matches, and continuing on to the next needle. This iteration proceeds until we run out of needles.</p>
<p>When we have a data frame with multiple columns, we add a layer of recursion to this. For the first column, we find the locations of the lower/upper duplicate of the current needle, and we find the locations of the lower/upper matches in the haystack. If we are on the final column in the data frame, we record the matches, otherwise we pass this information on to another call to <code>df_locate_matches_recurse()</code>, bumping the column index and using these refined lower/upper bounds as the starting bounds for the next column.</p>
<p>I think an example would be useful here, so below I step through this process for a few iterations:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="co"># these are sorted already for simplicity</span></span>
<span><span class="va">needles</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/data_frame.html">data_frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">4</span>, <span class="fl">5</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">haystack</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/data_frame.html">data_frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">4</span>, <span class="fl">4</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">needles</span></span>
<span><span class="co">#&gt;   x y</span></span>
<span><span class="co">#&gt; 1 1 1</span></span>
<span><span class="co">#&gt; 2 1 2</span></span>
<span><span class="co">#&gt; 3 2 3</span></span>
<span><span class="co">#&gt; 4 2 4</span></span>
<span><span class="co">#&gt; 5 2 5</span></span>
<span><span class="co">#&gt; 6 3 3</span></span>
<span></span>
<span><span class="va">haystack</span></span>
<span><span class="co">#&gt;   x y</span></span>
<span><span class="co">#&gt; 1 1 2</span></span>
<span><span class="co">#&gt; 2 1 3</span></span>
<span><span class="co">#&gt; 3 2 4</span></span>
<span><span class="co">#&gt; 4 2 4</span></span>
<span><span class="co">#&gt; 5 3 1</span></span>
<span></span>
<span><span class="co">## Column 1, iteration 1</span></span>
<span></span>
<span><span class="co"># start at midpoint in needles</span></span>
<span><span class="co"># this corresponds to x==2</span></span>
<span><span class="va">loc_mid_needles</span> <span class="op">&lt;-</span> <span class="fl">3L</span></span>
<span></span>
<span><span class="co"># finding all x==2 values in needles gives us:</span></span>
<span><span class="va">loc_lower_duplicate_needles</span> <span class="op">&lt;-</span> <span class="fl">3L</span></span>
<span><span class="va">loc_upper_duplicate_needles</span> <span class="op">&lt;-</span> <span class="fl">5L</span></span>
<span></span>
<span><span class="co"># finding matches in haystack give us:</span></span>
<span><span class="va">loc_lower_match_haystack</span> <span class="op">&lt;-</span> <span class="fl">3L</span></span>
<span><span class="va">loc_upper_match_haystack</span> <span class="op">&lt;-</span> <span class="fl">4L</span></span>
<span></span>
<span><span class="co"># compute LHS/RHS bounds for next needle</span></span>
<span><span class="va">lhs_loc_lower_bound_needles</span> <span class="op">&lt;-</span> <span class="fl">1L</span> <span class="co"># original lower bound</span></span>
<span><span class="va">lhs_loc_upper_bound_needles</span> <span class="op">&lt;-</span> <span class="fl">2L</span> <span class="co"># lower_duplicate-1</span></span>
<span></span>
<span><span class="va">rhs_loc_lower_bound_needles</span> <span class="op">&lt;-</span> <span class="fl">6L</span> <span class="co"># upper_duplicate+1</span></span>
<span><span class="va">rhs_loc_upper_bound_needles</span> <span class="op">&lt;-</span> <span class="fl">6L</span> <span class="co"># original upper bound</span></span>
<span></span>
<span><span class="co"># We still have a 2nd column to check. So recurse and pass on the current</span></span>
<span><span class="co"># duplicate and match bounds to start the 2nd column with.</span></span>
<span></span>
<span><span class="co">## Column 2, iteration 1</span></span>
<span></span>
<span><span class="co"># midpoint of [3, 5]</span></span>
<span><span class="co"># value y==4</span></span>
<span><span class="va">loc_mid_needles</span> <span class="op">&lt;-</span> <span class="fl">4L</span></span>
<span></span>
<span><span class="va">loc_lower_duplicate_needles</span> <span class="op">&lt;-</span> <span class="fl">4L</span></span>
<span><span class="va">loc_upper_duplicate_needles</span> <span class="op">&lt;-</span> <span class="fl">4L</span></span>
<span></span>
<span><span class="va">loc_lower_match_haystack</span> <span class="op">&lt;-</span> <span class="fl">3L</span></span>
<span><span class="va">loc_upper_match_haystack</span> <span class="op">&lt;-</span> <span class="fl">4L</span></span>
<span></span>
<span><span class="co"># last column, so record matches</span></span>
<span><span class="co"># - this was location 4 in needles</span></span>
<span><span class="co"># - lower match in haystack is at loc 3</span></span>
<span><span class="co"># - match size is 2</span></span>
<span></span>
<span><span class="co"># Now handle LHS and RHS of needle midpoint</span></span>
<span><span class="va">lhs_loc_lower_bound_needles</span> <span class="op">&lt;-</span> <span class="fl">3L</span> <span class="co"># original lower bound</span></span>
<span><span class="va">lhs_loc_upper_bound_needles</span> <span class="op">&lt;-</span> <span class="fl">3L</span> <span class="co"># lower_duplicate-1</span></span>
<span></span>
<span><span class="va">rhs_loc_lower_bound_needles</span> <span class="op">&lt;-</span> <span class="fl">5L</span> <span class="co"># upper_duplicate+1</span></span>
<span><span class="va">rhs_loc_upper_bound_needles</span> <span class="op">&lt;-</span> <span class="fl">5L</span> <span class="co"># original upper bound</span></span>
<span></span>
<span><span class="co">## Column 2, iteration 2 (using LHS bounds)</span></span>
<span></span>
<span><span class="co"># midpoint of [3,3]</span></span>
<span><span class="co"># value of y==3</span></span>
<span><span class="va">loc_mid_needles</span> <span class="op">&lt;-</span> <span class="fl">3L</span></span>
<span></span>
<span><span class="va">loc_lower_duplicate_needles</span> <span class="op">&lt;-</span> <span class="fl">3L</span></span>
<span><span class="va">loc_upper_duplicate_needles</span> <span class="op">&lt;-</span> <span class="fl">3L</span></span>
<span></span>
<span><span class="co"># no match! no y==3 in haystack for x==2</span></span>
<span><span class="co"># lower-match will always end up &gt; upper-match in this case</span></span>
<span><span class="va">loc_lower_match_haystack</span> <span class="op">&lt;-</span> <span class="fl">3L</span></span>
<span><span class="va">loc_upper_match_haystack</span> <span class="op">&lt;-</span> <span class="fl">2L</span></span>
<span></span>
<span><span class="co"># no LHS or RHS needle values to do, so we are done here</span></span>
<span></span>
<span><span class="co">## Column 2, iteration 3 (using RHS bounds)</span></span>
<span></span>
<span><span class="co"># same as above, range of [5,5], value of y==5, which has no match in haystack</span></span>
<span></span>
<span><span class="co">## Column 1, iteration 2 (LHS of first x needle)</span></span>
<span></span>
<span><span class="co"># Now we are done with the x needles from [3,5], so move on to the LHS and RHS</span></span>
<span><span class="co"># of that. Here we would do the LHS:</span></span>
<span></span>
<span><span class="co"># midpoint of [1,2]</span></span>
<span><span class="va">loc_mid_needles</span> <span class="op">&lt;-</span> <span class="fl">1L</span></span>
<span></span>
<span><span class="co"># ...</span></span>
<span></span>
<span><span class="co">## Column 1, iteration 3 (RHS of first x needle)</span></span>
<span></span>
<span><span class="co"># midpoint of [6,6]</span></span>
<span><span class="va">loc_mid_needles</span> <span class="op">&lt;-</span> <span class="fl">6L</span></span>
<span></span>
<span><span class="co"># ...</span></span></code></pre><p></p></div>
<p>In the real code, rather than comparing the double values of the columns directly, we replace each column with pseudo "joint ranks" computed between the i-th column of <code>needles</code> and the i-th column of <code>haystack</code>. It is approximately like doing <code>vec_rank(vec_c(needles$x, haystack$x), type = "dense")</code>, then splitting the resulting ranks back up into their corresponding needle/haystack columns. This keeps the recursion code simpler, because we only have to worry about comparing integers.</p>
</div>

<div class="section">
<h3 id="non-equi-conditions-and-containers">Non-equi conditions and containers<a class="anchor" aria-label="anchor" href="#non-equi-conditions-and-containers"></a></h3>


<p>At this point we can talk about non-equi conditions like <code>&lt;</code> or <code>&gt;=</code>. The general idea is pretty simple, and just builds on the above algorithm. For example, start with the <code>x</code> column from needles/haystack above:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="va">needles</span><span class="op">$</span><span class="va">x</span></span>
<span><span class="co">#&gt; [1] 1 1 2 2 2 3</span></span>
<span></span>
<span><span class="va">haystack</span><span class="op">$</span><span class="va">x</span></span>
<span><span class="co">#&gt; [1] 1 1 2 2 3</span></span></code></pre><p></p></div>
<p>If we used a condition of <code>&lt;=</code>, then we'd do everything the same as before:</p><ul><li><p>Midpoint in needles is location 3, value <code>x==2</code></p></li>
<li><p>Find lower/upper duplicates in needles, giving locations <code>[3, 5]</code></p></li>
<li><p>Find lower/upper <em>exact</em> match in haystack, giving locations <code>[3, 4]</code></p></li>
</ul><p>At this point, we need to "adjust" the <code>haystack</code> match bounds to account for the condition. Since <code>haystack</code> is ordered, our "rule" for <code>&lt;=</code> is to keep the lower match location the same, but extend the upper match location to the upper bound, so we end up with <code>[3, 5]</code>. We know we can extend the upper match location because every haystack value after the exact match should be less than the needle. Then we just record the matches and continue on normally.</p>
<p>This approach is really nice, because we only have to exactly match the <code>needle</code> in <code>haystack</code>. We don't have to compare each needle against every value in <code>haystack</code>, which would take a massive amount of time.</p>
<p>However, it gets slightly more complex with data frames with multiple columns. Let's go back to our original <code>needles</code> and <code>haystack</code> data frames and apply the condition <code>&lt;=</code> to each column. Here is another worked example, which shows a case where our "rule" falls apart on the second column.</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="va">needles</span></span>
<span><span class="co">#&gt;   x y</span></span>
<span><span class="co">#&gt; 1 1 1</span></span>
<span><span class="co">#&gt; 2 1 2</span></span>
<span><span class="co">#&gt; 3 2 3</span></span>
<span><span class="co">#&gt; 4 2 4</span></span>
<span><span class="co">#&gt; 5 2 5</span></span>
<span><span class="co">#&gt; 6 3 3</span></span>
<span></span>
<span><span class="va">haystack</span></span>
<span><span class="co">#&gt;   x y</span></span>
<span><span class="co">#&gt; 1 1 2</span></span>
<span><span class="co">#&gt; 2 1 3</span></span>
<span><span class="co">#&gt; 3 2 4</span></span>
<span><span class="co">#&gt; 4 2 4</span></span>
<span><span class="co">#&gt; 5 3 1</span></span>
<span></span>
<span><span class="co"># `condition = c("&lt;=", "&lt;=")`</span></span>
<span></span>
<span><span class="co">## Column 1, iteration 1</span></span>
<span></span>
<span><span class="co"># x == 2</span></span>
<span><span class="va">loc_mid_needles</span> <span class="op">&lt;-</span> <span class="fl">3L</span></span>
<span></span>
<span><span class="va">loc_lower_duplicate_needles</span> <span class="op">&lt;-</span> <span class="fl">3L</span></span>
<span><span class="va">loc_upper_duplicate_needles</span> <span class="op">&lt;-</span> <span class="fl">5L</span></span>
<span></span>
<span><span class="co"># finding exact matches in haystack give us:</span></span>
<span><span class="va">loc_lower_match_haystack</span> <span class="op">&lt;-</span> <span class="fl">3L</span></span>
<span><span class="va">loc_upper_match_haystack</span> <span class="op">&lt;-</span> <span class="fl">4L</span></span>
<span></span>
<span><span class="co"># because haystack is ordered we know we can expand the upper bound automatically</span></span>
<span><span class="co"># to include everything past the match. i.e. needle of x==2 must be less than</span></span>
<span><span class="co"># the haystack value at loc 5, which we can check by seeing that it is x==3.</span></span>
<span><span class="va">loc_lower_match_haystack</span> <span class="op">&lt;-</span> <span class="fl">3L</span></span>
<span><span class="va">loc_upper_match_haystack</span> <span class="op">&lt;-</span> <span class="fl">5L</span></span>
<span></span>
<span><span class="co">## Column 2, iteration 1</span></span>
<span></span>
<span><span class="co"># needles range of [3, 5]</span></span>
<span><span class="co"># y == 4</span></span>
<span><span class="va">loc_mid_needles</span> <span class="op">&lt;-</span> <span class="fl">4L</span></span>
<span></span>
<span><span class="va">loc_lower_duplicate_needles</span> <span class="op">&lt;-</span> <span class="fl">4L</span></span>
<span><span class="va">loc_upper_duplicate_needles</span> <span class="op">&lt;-</span> <span class="fl">4L</span></span>
<span></span>
<span><span class="co"># finding exact matches in haystack give us:</span></span>
<span><span class="va">loc_lower_match_haystack</span> <span class="op">&lt;-</span> <span class="fl">3L</span></span>
<span><span class="va">loc_upper_match_haystack</span> <span class="op">&lt;-</span> <span class="fl">4L</span></span>
<span></span>
<span><span class="co"># lets try using our rule, which tells us we should be able to extend the upper</span></span>
<span><span class="co"># bound:</span></span>
<span><span class="va">loc_lower_match_haystack</span> <span class="op">&lt;-</span> <span class="fl">3L</span></span>
<span><span class="va">loc_upper_match_haystack</span> <span class="op">&lt;-</span> <span class="fl">5L</span></span>
<span></span>
<span><span class="co"># but the haystack value of y at location 5 is y==1, which is not less than y==4</span></span>
<span><span class="co"># in the needles! looks like our rule failed us.</span></span></code></pre><p></p></div>
<p>If you read through the above example, you'll see that the rule didn't work here. The problem is that while <code>haystack</code> is ordered (by <code><a href="vec_order.html">vec_order()</a></code>s standards), each column isn't ordered <em>independently</em> of the others. Instead, each column is ordered within the "group" created by previous columns. Concretely, <code>haystack</code> here has an ordered <code>x</code> column, but if you look at <code>haystack$y</code> by itself, it isn't ordered (because of that 1 at the end). That is what causes the rule to fail.</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="va">haystack</span></span>
<span><span class="co">#&gt;   x y</span></span>
<span><span class="co">#&gt; 1 1 2</span></span>
<span><span class="co">#&gt; 2 1 3</span></span>
<span><span class="co">#&gt; 3 2 4</span></span>
<span><span class="co">#&gt; 4 2 4</span></span>
<span><span class="co">#&gt; 5 3 1</span></span></code></pre><p></p></div>
<p>To fix this, we need to create haystack "containers" where the values within each container are all <em>totally</em> ordered. For <code>haystack</code> that would create 2 containers and look like:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="va">haystack</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>,<span class="op">]</span></span>
<span><span class="co">#&gt; # A tibble: 4 × 2</span></span>
<span><span class="co">#&gt;       x     y</span></span>
<span><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1     1     2</span></span>
<span><span class="co">#&gt; 2     1     3</span></span>
<span><span class="co">#&gt; 3     2     4</span></span>
<span><span class="co">#&gt; 4     2     4</span></span>
<span></span>
<span><span class="va">haystack</span><span class="op">[</span><span class="fl">5</span>,<span class="op">]</span></span>
<span><span class="co">#&gt; # A tibble: 1 × 2</span></span>
<span><span class="co">#&gt;       x     y</span></span>
<span><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1     3     1</span></span></code></pre><p></p></div>
<p>This is essentially what <code>computing_nesting_container_ids()</code> does. You can actually see these ids with the helper, <code>compute_nesting_container_info()</code>:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="va">haystack2</span> <span class="op">&lt;-</span> <span class="va">haystack</span></span>
<span></span>
<span><span class="co"># we really pass along the integer ranks, but in this case that is equivalent</span></span>
<span><span class="co"># to converting our double columns to integers</span></span>
<span><span class="va">haystack2</span><span class="op">$</span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">haystack2</span><span class="op">$</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="va">haystack2</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">haystack2</span><span class="op">$</span><span class="va">y</span><span class="op">)</span></span>
<span></span>
<span><span class="va">info</span> <span class="op">&lt;-</span> <span class="fu">compute_nesting_container_info</span><span class="op">(</span><span class="va">haystack2</span>, condition <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"&lt;="</span>, <span class="st">"&lt;="</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># the ids are in the second slot.</span></span>
<span><span class="co"># container ids break haystack into [1, 4] and [5, 5].</span></span>
<span><span class="va">info</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] 0 0 0 0 1</span></span></code></pre><p></p></div>
<p>So the idea is that for each needle, we look in each haystack container and find all the matches, then we aggregate all of the matches once at the end. <code>df_locate_matches_with_containers()</code> has the job of iterating over the containers.</p>
<p>Computing totally ordered containers can be expensive, but luckily it doesn't happen very often in normal usage.</p><ul><li><p>If there are all <code>==</code> conditions, we don't need containers (i.e. any equi join)</p></li>
<li><p>If there is only 1 non-equi condition and no conditions after it, we don't need containers (i.e. most rolling joins)</p></li>
<li><p>Otherwise the typical case where we need containers is if we have something like <code>date &gt;= lower, date &lt;= upper</code>. Even so, the computation cost generally scales with the number of columns in <code>haystack</code> you compute containers with (here 2), and it only really slows down around 4 columns or so, which I haven't ever seen a real life example of.</p></li>
</ul></div>

    </div>

  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside></div>


   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by <a href="https://hadley.nz" class="external-link">Hadley Wickham</a>, <a href="https://github.com/lionel-" class="external-link">Lionel Henry</a>, <a href="https://github.com/DavisVaughan" class="external-link">Davis Vaughan</a>, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" width="62" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

  </div></footer></body></html>

